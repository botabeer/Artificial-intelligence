import random
import re
from linebot.models import TextSendMessage

class GuessSingerGame:
    def __init__(self, line_bot_api):
        self.line_bot_api = line_bot_api
        self.current_song = None
        self.correct_answer = None

        # ๐ถ ูุงุฆูุฉ ุงูุฃุบุงูู (ุจูุชูู + ููุงู + ุชูููุญ + ุฌูุณูุฉ)
        self.songs = [
            # ุฎููุฌูุฉ
            {
                "lyrics": ["ุณุฃูููู ุงูููู ููุด ุณุงูุฑ", "ููุช ูููู ูู ุนูููู ุณุญุฑ"],
                "artist": "ุญุณูู ุงูุฌุณูู",
                "nationality": "ุฅูุงุฑุงุชู",
                "hint": "ููุงู ุฎููุฌู ุจุตูุช ุฏุงูุฆ ูุฃุบุงูู ูุทููุฉ ูุนุงุทููุฉ โค๏ธ"
            },
            {
                "lyrics": ["ูุง ุทูุฑ ูุง ุทุงูุฑ ูุง ุฑุงูุญ ุจูุงุฏ ุงูุฎูุฑ", "ุณูู ูู ุนูู ุงููู ุฃุญุจูุง ูุซูุฑ"],
                "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู",
                "nationality": "ุณุนูุฏู",
                "hint": "ูุทุฑุจ ุณุนูุฏู ูู ุงูุฌูู ุงูุฐูุจู ๐ถ"
            },
            {
                "lyrics": ["ุชุนุจุช ูุฃูุง ุฃูุงุฏู ุนูู ุงูููู", "ููุง ูุณูุน ูุฏุงุฆู ุบูุฑ ุงููููู"],
                "artist": "ุฑุงุดุฏ ุงููุงุฌุฏ",
                "nationality": "ุณุนูุฏู",
                "hint": "ูู ูุจุงุฑ ูุฌูู ุงูุฎููุฌ ูุตูุชู ูุงุนู ููููุฒ ๐ค"
            },
            {
                "lyrics": ["ุนูู ููุฏู ุฃูุง ุฌูุช", "ููุง ููุฑุช ูู ุงูุจุงูู"],
                "artist": "ุทูุงู ูุฏุงุญ",
                "nationality": "ุณุนูุฏู",
                "hint": "ุฃุญุฏ ุฑููุงุฏ ุงูุฃุบููุฉ ุงูุณุนูุฏูุฉุ ูููููุจ ุจุตูุช ุงูุฃุฑุถ ๐"
            },
            {
                "lyrics": ["ุขู ูุง ุฏููุง ุขู ูุง ูุงุณ", "ุฑุงุญ ุงูููู ูุงููู ูุถู ูุง ููุฏุงุณ"],
                "artist": "ูุญูุฏ ุนุจุฏู",
                "nationality": "ุณุนูุฏู",
                "hint": "ููุงู ุงูุนุฑุจ ๐ธ๐ฆ"
            },
            {
                "lyrics": ["ุฃุญุจู ููุช ููุช", "ููุง ุฃุฏุฑู ุดููู ุฃูุตู ุญุจู"],
                "artist": "ูุงุฌุฏ ุงููููุฏุณ",
                "nationality": "ุนุฑุงูู",
                "hint": "ูููุฏุณ ุงูุฃุบููุฉ ุงูุนุฑุจูุฉ ๐ผ"
            },
            {
                "lyrics": ["ุจููุช ููู ูุงุฑูุชูู ูุจููุช", "ูุตุฑุช ุฃูุงุฌู ุทููู ูู ุฏูุนู"],
                "artist": "ูุงุธู ุงูุณุงูุฑ",
                "nationality": "ุนุฑุงูู",
                "hint": "ููุตุฑ ุงูุบูุงุก ุงูุนุฑุจู ๐ป"
            },
            {
                "lyrics": ["ุฃูุง ููู ุนูู ุญุฏ ุงูุซุฑูุง", "ููู ุฏููู ูุถูุน ุงููุนูู"],
                "artist": "ูุงุธู ุงูุณุงูุฑ",
                "nationality": "ุนุฑุงูู",
                "hint": "ุตุงุญุจ ุงููุตุงุฆุฏ ุงูุฑููุงูุณูุฉ ุงูุนุฑุงููุฉ ๐"
            },
            {
                "lyrics": ["ูุง ุฃูู ููุง ุฃุญูู ุญุจูุจุฉ", "ูุง ุฃูู ุญุจ ุนุดุชู ุจุฏููุชู"],
                "artist": "ูุคุงุฏ ุนุจุฏุงููุงุญุฏ",
                "nationality": "ูููู",
                "hint": "ูุทุฑุจ ุฎููุฌู ุดุงุจ ุจุตูุช ุฌููู โค๏ธ"
            },
            {
                "lyrics": ["ูุง ุบุงูู ุนูู ููุจู", "ูุฌูุฏู ุจุงูุฏููุง ูููููู"],
                "artist": "ุนุจุฏุงููุฌูุฏ ุนุจุฏุงููู",
                "nationality": "ุณุนูุฏู",
                "hint": "ูู ุฃุจุฑุฒ ููุงูู ุงูุณุนูุฏูุฉ ๐ถ"
            },

            # ูุตุฑูุฉ
            {
                "lyrics": ["ุญุจูุจู ูุง ููุฑ ุงูุนูู", "ูุง ุณุงูู ุฎูุงูู"],
                "artist": "ุนูุฑู ุฏูุงุจ",
                "nationality": "ูุตุฑู",
                "hint": "ุงููุถุจุฉ ุงููุตุฑูุฉ ๐"
            },
            {
                "lyrics": ["ุชููู ูุนุงู ูุง ุฌููู", "ูุฃูุง ุญุชู ูุงูุช ุจุนูุฏ ุนูู"],
                "artist": "ุนูุฑู ุฏูุงุจ",
                "nationality": "ูุตุฑู",
                "hint": "ูุฌู ุงูุบูุงุก ุงูุนุฑุจู ูุฃููููุฉ ุงูุชุณุนููุงุช ๐"
            },
            {
                "lyrics": ["ูู ููู ูู ุฏู ูุง ุญูู", "ุจุญุจู ุฃูุชุฑ ูุฃูุชุฑ"],
                "artist": "ุดูุฑูู ุนุจุฏุงูููุงุจ",
                "nationality": "ูุตุฑูุฉ",
                "hint": "ุตุงุญุจุฉ ุงูุตูุช ุงูุฏุงูุฆ ูุงูุนููู ๐ค"
            },
            {
                "lyrics": ["ุจุญุจู ูุง ุตุงุญุจู ูุง ุงููู ูุนุงูุง", "ูู ููุช ุงูุถูู ุฏุงูููุง ุฌูุจู"],
                "artist": "ุชุงูุฑ ุญุณูู",
                "nationality": "ูุตุฑู",
                "hint": "ูุฌู ุงูุฌูู ๐ซ"
            },
            {
                "lyrics": ["ููุจู ุงุฎุชุงุฑู ูู ุงููุงุณ ูููุง", "ูุฃูุง ุฑุงุถู ุจูุฏุฑู ูุญูุงุชู ูุนุงู"],
                "artist": "ูุญูุฏ ูุคุงุฏ",
                "nationality": "ูุตุฑู",
                "hint": "ูุทุฑุจ ุงูุชุณุนููุงุช ุงููุญุจูุจ ๐ต"
            },
            {
                "lyrics": ["ุฃูุง ุนุงูุด ูุง ูุงุณ ูุนุงู ูู ุงูุฌูุฉ", "ุจุญุจูุง ููุด ูููู ุฃุณุชุบูู"],
                "artist": "ูุญูุฏ ูููุฑ",
                "nationality": "ูุตุฑู",
                "hint": "ุงูููู ุงูููุจู ๐ถ"
            },
            {
                "lyrics": ["ูู ููุช ููู ุฃูุณู ุญุจูุจู", "ุงุจูู ุงูุณุงูู ุฎูุงุต"],
                "artist": "ุฃูุบุงู",
                "nationality": "ูุตุฑูุฉ",
                "hint": "ูู ุฃูุนู ุงูุฃุตูุงุช ุงููุณุงุฆูุฉ ุงููุตุฑูุฉ ๐ง"
            },

            # ุดุงููุฉ
            {
                "lyrics": ["ุนูููู ุณูุฏ ูุญูุงุฌุจู ุณูุฏ", "ูุง ููุจู ููู ุจุชุญุจ ูุฏู"],
                "artist": "ุฃุตุงูุฉ ูุตุฑู",
                "nationality": "ุณูุฑูุฉ",
                "hint": "ูููุฉ ุงูุฅุญุณุงุณ ุงูุณูุฑูุฉ ๐"
            },
            {
                "lyrics": ["ูุง ูุณูุฑูู ูุง ุนูููู", "ููู ุฃูุง ูุงูุช ูุด ุณูุง"],
                "artist": "ูุงูุณู ุนุฌุฑู",
                "nationality": "ูุจูุงููุฉ",
                "hint": "ูุฌู ุฌููู ูุตูุช ุทูููู ูุญุจุจ ๐"
            },
            {
                "lyrics": ["ุงุดุชููุงูู ูุง ุญูู", "ูููู ูู ุฒูุงู"],
                "artist": "ุฑุงุบุจ ุนูุงูุฉ",
                "nationality": "ูุจูุงูู",
                "hint": "ุงูุณูุจุฑ ุณุชุงุฑ ุงููุจูุงูู ๐"
            },
            {
                "lyrics": ["ุฃูุง ูุญุจูุจู ูุญุจูุจู ุฅููู", "ูุง ุนุตููุฑุฉ ุงูุณุงุญุฉ"],
                "artist": "ููุฑูุฒ",
                "nationality": "ูุจูุงููุฉ",
                "hint": "ุตูุช ุงูุตุจุงุญ ูุงูุฃูู ๐ค๏ธ"
            },
            {
                "lyrics": ["ุขู ูู ูุนุจุช ูุง ุฒูุฑ", "ูุชุจุฏู ุญุงูู ูุญุงูู"],
                "artist": "ุฃุญูุฏ ุดูุจุฉ",
                "nationality": "ูุตุฑู",
                "hint": "ูุทุฑุจ ุดุนุจู ุจุตูุช ููู ๐"
            },

            # ูุบุฑุจูุฉ ูุชููุณูุฉ
            {
                "lyrics": ["ูุง ุจูุช ุจูุงุฏู ุฒููุฉ", "ุงูุฒูู ุฏูุงูู ูุง ูุชูุณู"],
                "artist": "ุณุนุฏ ููุฌุฑุฏ",
                "nationality": "ูุบุฑุจู",
                "hint": "ุตุงุญุจ ุฃุบููุฉ (ุงูุช ูุนูู) ๐ง"
            },
            {
                "lyrics": ["ููุงุจู ูุงุณ ููุงุณ", "ูููุงุฑู ูุงุณ ููุงุณ"],
                "artist": "ูุทููุฉ",
                "nationality": "ุชููุณูุฉ",
                "hint": "ูุทุฑุจุฉ ุชููุณูุฉ ุฑุงููุฉ ูุฃูููุฉ ๐๏ธ"
            }
        ]

    def normalize_text(self, text):
        """ุชุทุจูุน ุงููุต ููููุงุฑูุฉ"""
        text = text.strip().lower()
        text = re.sub(r'^ุงู', '', text)
        text = text.replace('ุฃ', 'ุง').replace('ุฅ', 'ุง').replace('ุข', 'ุง')
        text = text.replace('ุฉ', 'ู').replace('ู', 'ู')
        text = re.sub(r'[\u064B-\u065F]', '', text)
        return text

    def start_game(self):
        """ุจุฏุก ุงููุนุจุฉ"""
        song_data = random.choice(self.songs)
        self.current_song = song_data
        self.correct_answer = song_data["artist"]

        lyrics_text = "\n".join(song_data["lyrics"])
        hint_text = f"\n\n<small>๐ก ุงูุชูููุญ: {song_data['hint']} ({song_data['nationality']})</small>"

        return TextSendMessage(
            text=f"๐ต ุฎูู ูู ุงููุบูู:\n\n\"{lyrics_text}\"{hint_text}"
        )

    def check_answer(self, answer, user_id, display_name):
        """ุงูุชุญูู ูู ุงูุฅุฌุงุจุฉ"""
        if not self.current_song:
            return TextSendMessage(text="ุงุจุฏุฃ ุงููุนุจุฉ ุฃููุงู ุจูุชุงุจุฉ (ุงุจุฏุฃ) ๐ฎ")

        user_answer = self.normalize_text(answer)
        correct_answer = self.normalize_text(self.correct_answer)

        if user_answer in correct_answer or correct_answer in user_answer:
            points = 10
            msg = (
                f"โ ุฃุญุณูุช ูุง {display_name}!\n"
                f"๐ค ุงููุบูู ูู: {self.correct_answer}\n"
                f"โญ +{points} ููุงุท\n\n"
                f"ุงูุชุจ (ุงุจุฏุฃ) ูุชุฎููู ูุบูู ุฌุฏูุฏ ๐ถ"
            )
        else:
            msg = (
                f"โ ุฎุทุฃ!\n"
                f"ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: {self.correct_answer}\n\n"
                f"ุงูุชุจ (ุงุจุฏุฃ) ูุฌููุฉ ุฌุฏูุฏุฉ ๐ต"
            )

        self.current_song = None
        return TextSendMessage(text=msg)
