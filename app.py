from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os
import google.generativeai as genai

app = Flask(__name__)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
if not all([LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET, GEMINI_API_KEY]):
    raise ValueError("ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")

# Ø¥Ø¹Ø¯Ø§Ø¯ LINE Bot
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# Ø¥Ø¹Ø¯Ø§Ø¯ Gemini AI
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-pro')

# ØªØªØ¨Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
user_data = {}

# Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„
FOREST_TEST = """ðŸŒ² Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„Ù†ÙØ³ÙŠ

ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ ØªÙ…Ø´ÙŠ ÙÙŠ ØºØ§Ø¨Ø© Ø¹Ø¨Ø± Ø·Ø±ÙŠÙ‚ Ù…Ø­Ø§Ø· Ø¨Ø§Ù„Ø£Ø´Ø¬Ø§Ø±

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù†Ø¸Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±ØŒ Ù‡Ù„ Ù‡ÙŠ Ù…Ù†Ø¸Ù…Ø© Ø£Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©ØŸ

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù‡Ù„ Ø§Ù„ÙˆÙ‚Øª Ù„ÙŠÙ„ Ø£Ù… Ù†Ù‡Ø§Ø±ØŸ

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø«: Ù‡Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ø±ÙŠØ¶ Ø£Ù… Ø¶ÙŠÙ‚ØŸ

ðŸ”‘ Ù…ÙˆÙ‚Ù Ø§Ù„Ù…ÙØªØ§Ø­
Ø³ÙˆÙ ØªØ³ØªÙ…Ø± Ø¨Ø§Ù„Ø³ÙŠØ±ØŒ ÙˆÙØ¬Ø£Ø© Ø³ØªØ±Ù‰ Ù…ÙØªØ§Ø­Ù‹Ø§ Ù…Ù„Ù‚Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶.

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø¹: ÙƒÙŠÙ ÙŠØ¨Ø¯Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ØŸ Ù‚Ø¯ÙŠÙ… Ø£Ù… Ø¬Ø¯ÙŠØ¯ØŸ

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø®Ø§Ù…Ø³: Ù‡Ù„ Ø³ØªÙ„ØªÙ‚Ø· Ø§Ù„Ù…ÙØªØ§Ø­ Ø£Ù… ØªØªØ±ÙƒÙ‡ØŸ

ðŸ» Ù…ÙˆÙ‚Ù Ø§Ù„Ø¯Ø¨
Ø³ÙˆÙ ØªØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø³ÙŠØ±ØŒ ÙˆÙØ¬Ø£Ø© Ø³ØªØ±Ù‰ Ø¯Ø¨Ù‹Ø§ ÙŠÙ‚ØªØ±Ø¨.

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø§Ø¯Ø³: Ù‡Ù„ Ø§Ù„Ø¯Ø¨ Ø¹Ø¯ÙˆØ§Ù†ÙŠ Ø£Ù… ÙˆØ¯ÙˆØ¯ØŸ

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ø¹: Ù…Ø§ Ø­Ø¬Ù… Ø§Ù„Ø¯Ø¨ØŸ

ðŸº Ù…ÙˆÙ‚Ù Ø§Ù„Ø¬Ø±Ø©
ÙŠØ®ØªÙÙŠ Ø§Ù„Ø¯Ø¨ ÙˆØªØ³ØªÙ…Ø± Ø£Ù†Øª ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ. ÙØ¬Ø£Ø© ØªØ±Ù‰ Ø¬Ø±Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚.

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù…Ù†: ØµÙ Ø§Ù„Ø¬Ø±Ø©. Ù…Ù…Ø§ Ù‡ÙŠ Ù…ØµÙ†ÙˆØ¹Ø©ØŸ

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ø³Ø¹: Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ø¨Ø¯Ø§Ø®Ù„Ù‡Ø§ØŸ

ðŸ  Ù…ÙˆÙ‚Ù Ø§Ù„Ù…Ù†Ø²Ù„
Ø³ØªØªØ±Ùƒ Ø§Ù„Ø¬Ø±Ø© ÙˆØªØªØ§Ø¨Ø¹ Ø·Ø±ÙŠÙ‚ÙƒØŒ ÙˆØ¨Ø¹Ø¯ Ù„Ø­Ø¸Ø§Øª Ø³ÙŠØ¸Ù‡Ø± Ù…Ù†Ø²Ù„.

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ø§Ø´Ø±: Ù…Ø§ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø²Ù„ØŸ

Ù…Ù† Ø¯Ø§Ø®Ù„Ù‡ØŒ ØªØ³Ù…Ø¹ Ø±Ø¬Ù„Ø§Ù‹ ÙŠØµØ±Ø® ÙˆÙŠØªÙˆØ³Ù„ Ù„ØªÙØªØ­ Ø§Ù„Ø¨Ø§Ø¨.

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±: Ù‡Ù„ Ø³ØªÙØªØ­ Ø§Ù„Ø¨Ø§Ø¨ØŸ

â¬œ Ø§Ù„Ø£Ø¨ÙŠØ¶
ÙØ¬Ø£Ø©ØŒ ÙŠØµØ¨Ø­ ÙƒÙ„ Ø´ÙŠØ¡ Ø£Ø¨ÙŠØ¶. Ù„Ù… ØªØ¹Ø¯ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†.

â“ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±: Ù…Ø§Ø°Ø§ Ø³ØªÙØ¹Ù„ØŸ Ù‡Ù„ ØªØ³ØªØ³Ù„Ù… Ø£Ù… ØªØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¨Ø­Ø«ØŸ

â€”â€”â€”â€”â€”â€”â€”â€”â€”

Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„ØŒ Ù…Ø«Ø§Ù„:
Ù…Ù†Ø¸Ù…Ø©ØŒ Ù†Ù‡Ø§Ø±ØŒ Ø¹Ø±ÙŠØ¶ØŒ Ø¬Ø¯ÙŠØ¯ØŒ Ù†Ø¹Ù…ØŒ ÙˆØ¯ÙˆØ¯ØŒ ÙƒØ¨ÙŠØ±ØŒ Ø®Ø´Ø¨ØŒ Ù…Ø§Ø¡ØŒ ÙƒØ¨ÙŠØ±ØŒ Ù†Ø¹Ù…ØŒ Ø£Ø³ØªÙ…Ø±"""

def get_user_data(user_id):
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©"""
    if user_id not in user_data:
        user_data[user_id] = {
            'links_count': 0,
            'conversation_history': [],
            'test_mode': None,
            'test_data': {}
        }
    return user_data[user_id]

def analyze_forest_test(answers):
    """ØªØ­Ù„ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©"""
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø¹Ù„Ù… Ø§Ù„Ù†ÙØ³ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©.

Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„Ù†ÙØ³ÙŠ:
{answers}

Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ù„Ù„ØªØ­Ù„ÙŠÙ„:

1. Ø§Ù„Ø£Ø´Ø¬Ø§Ø± Ø§Ù„Ù…Ù†Ø¸Ù…Ø© = Ø´Ø®Øµ Ù…Ù†Ø·Ù‚ÙŠ ÙŠØ­Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© = ÙŠÙ‡ØªÙ… Ø¨Ø§Ù„Ø¬ÙˆÙ‡Ø±
2. Ø§Ù„Ù†Ù‡Ø§Ø± = ØªÙØ§Ø¤Ù„ ÙˆØ·ÙÙˆÙ„Ø© Ø³Ø¹ÙŠØ¯Ø©ØŒ Ø§Ù„Ù„ÙŠÙ„ = ØªØ´Ø§Ø¤Ù… Ø£Ùˆ Ø°ÙƒØ±ÙŠØ§Øª ØµØ¹Ø¨Ø©
3. Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙˆØ§Ø¶Ø­ = ÙŠÙ‚ÙŠÙ† ÙˆØ®Ø·Ø· ÙˆØ§Ø¶Ø­Ø©ØŒ Ø§Ù„Ø¶ÙŠÙ‚ = ØªØ±Ø¯Ø¯ ÙˆØ®ÙˆÙ Ù…Ù† Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„
4. Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… = Ø­Ù„Ù… Ù‚Ø¯ÙŠÙ…ØŒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ = Ø±ØºØ¨Ø© Ø­Ø¯ÙŠØ«Ø©ØŒ Ø§Ù„ÙƒØ¨ÙŠØ± = Ø±ØºØ¨Ø© ÙƒØ¨ÙŠØ±Ø©
5. Ø£Ø®Ø° Ø§Ù„Ù…ÙØªØ§Ø­ = Ø§Ù„Ø±ØºØ¨Ø§Øª Ø£Ù‚ÙˆÙ‰ Ù…Ù† Ø§Ù„Ù…Ø®Ø§ÙˆÙØŒ ØªØ±ÙƒÙ‡ = ÙŠØ®Ø§Ù Ù…Ù† Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„
6. Ø§Ù„Ø¯Ø¨ Ø§Ù„Ø¹Ø¯ÙˆØ§Ù†ÙŠ = Ù‚Ù„Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ØŒ Ø§Ù„ÙˆØ¯ÙˆØ¯ = ÙŠØ³ÙŠØ·Ø± Ø¹Ù„Ù‰ Ù…Ø´Ø§ÙƒÙ„Ù‡
7. Ø­Ø¬Ù… Ø§Ù„Ø¯Ø¨ = Ø­Ø¬Ù… Ø¥Ø¯Ø±Ø§ÙƒÙ‡ Ù„Ù…Ø´Ø§ÙƒÙ„Ù‡
8. Ø§Ù„Ø¬Ø±Ø© = Ø¹Ù„Ø§Ù‚ØªÙ‡ Ø¨Ø§Ù„Ø£Ø¬ÙŠØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (ÙˆØ§Ù„Ø¯ÙŠÙ‡ ÙˆØ£Ø¬Ø¯Ø§Ø¯Ù‡)
9. Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø±Ø© = Ù…Ø§ ÙŠØ³ØªÙÙŠØ¯Ù‡ Ù…Ù† Ø§Ù„Ø£Ø¬ÙŠØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
10. Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø²Ù„ = Ø­Ø¬Ù… Ø£Ø­Ù„Ø§Ù…Ù‡ ÙˆØ·Ù…ÙˆØ­Ø§ØªÙ‡
11. ÙØªØ­ Ø§Ù„Ø¨Ø§Ø¨ = ÙŠØ«Ù‚ Ø¨Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒ Ø¹Ø¯Ù… Ø§Ù„ÙØªØ­ = Ø­Ø°Ø± ÙˆÙ„Ø§ ÙŠØ«Ù‚ Ø¨Ø³Ù‡ÙˆÙ„Ø©
12. Ø§Ù„Ø§Ø³ØªØ³Ù„Ø§Ù… = Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙˆØª ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ§ØªØŒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± = ÙŠØ±ÙØ¶ Ø§Ù„Ø§Ø³ØªØ³Ù„Ø§Ù…

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ÙØµÙ„Ø§Ù‹ ÙŠØ´Ù…Ù„:
ðŸ§  Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø®ØµÙŠØ©
ðŸ’­ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„ØªØ®Ø·ÙŠØ·
â¤ï¸ Ø§Ù„Ø¹ÙˆØ§Ø·Ù ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
ðŸ’ª Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
ðŸŽ¯ Ø§Ù„Ø£Ø­Ù„Ø§Ù… ÙˆØ§Ù„Ø·Ù…ÙˆØ­Ø§Øª
ðŸ”® Ù†ØµÙŠØ­Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©

Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚Ø§Ù‹ ÙˆØ¯Ù‚ÙŠÙ‚Ø§Ù‹ ÙˆØ¥ÙŠØ¬Ø§Ø¨ÙŠØ§Ù‹."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"Ø®Ø·Ø£: {e}")
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„"

def analyze_by_color(color):
    """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ÙØ¶Ù„"""
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø¹Ù„Ù… Ù†ÙØ³ Ø§Ù„Ø£Ù„ÙˆØ§Ù†.

Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ù„Ø´Ø®Øµ: {color}

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø´Ø®ØµÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ† ÙŠØªØ¶Ù…Ù†:

ðŸŽ¨ Ù…Ø¹Ù†Ù‰ Ø§Ù„Ù„ÙˆÙ† Ù†ÙØ³ÙŠØ§Ù‹
âœ¨ Ø§Ù„ØµÙØ§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù„Ù„Ø´Ø®Øµ
ðŸ’« Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
ðŸŒŸ Ø§Ù„Ø·Ø¨Ø§Ø¹ ÙˆØ§Ù„Ù…ÙŠÙˆÙ„
ðŸ’¼ Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©
â¤ï¸ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©
âš ï¸ Ù†Ù‚Ø§Ø· ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ Ù„Ù‡Ø§
ðŸŽ¯ Ù†ØµÙŠØ­Ø© Ø®ØªØ§Ù…ÙŠØ©

Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚Ø§Ù‹ ÙˆÙˆØ§Ù‚Ø¹ÙŠØ§Ù‹ ÙˆÙ…Ù„Ù‡Ù…Ø§Ù‹ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„"

def analyze_by_zodiac(sign):
    """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø±Ø¬"""
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø¹Ù„Ù… Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬ ÙˆØ§Ù„ÙÙ„Ùƒ.

Ø§Ù„Ø¨Ø±Ø¬: {sign}

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙÙ„ÙƒÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙŠØªØ¶Ù…Ù†:

â™ˆ ØµÙØ§Øª Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
âœ¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
ðŸ’« Ø§Ù„Ù…ÙˆØ§Ù‡Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
â¤ï¸ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø¹Ø§Ø·ÙÙŠØ© ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
ðŸ’¼ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‡Ù†ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
ðŸŒŸ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬ Ø§Ù„Ø£Ø®Ø±Ù‰
âš ï¸ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
ðŸ”® Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù†Ø¬Ø§Ø­
ðŸŽ¯ ØªÙˆÙ‚Ø¹Ø§Øª Ø¹Ø§Ù…Ø©

Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„Ø§Ù‹ ÙˆÙ…Ù…ØªØ¹Ø§Ù‹ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù† Ø§Ù„Ø¨Ø±Ø¬."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„"

def analyze_by_birth_month(month):
    """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯"""
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯.

Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: {month}

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙŠØªØ¶Ù…Ù†:

ðŸŒ™ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ÙˆÙ„ÙˆØ¯ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
âœ¨ Ø§Ù„ØµÙØ§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©
ðŸ’Ž Ø§Ù„Ù…ÙˆØ§Ù‡Ø¨ ÙˆØ§Ù„Ù‚Ø¯Ø±Ø§Øª
â¤ï¸ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø¹Ø§Ø·ÙÙŠØ©
ðŸŽ¯ Ø§Ù„Ø·Ù…ÙˆØ­Ø§Øª ÙˆØ§Ù„Ø£Ù‡Ø¯Ø§Ù
ðŸ’¼ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ù‡Ù†ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
ðŸŒŸ Ø§Ù„Ø£Ø­Ø¬Ø§Ø± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø¸ÙˆØ¸Ø©
ðŸ”® Ù†ØµØ§Ø¦Ø­ ÙˆØ¥Ø±Ø´Ø§Ø¯Ø§Øª
ðŸŽ Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© Ù„Ù‡Ù…

Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚Ø§Ù‹ ÙˆÙ…Ù„Ù‡Ù…Ø§Ù‹ ÙˆÙ…Ø¨Ù†ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø­Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù…ÙŠØ© ÙˆÙ†ÙØ³ÙŠØ©."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„"

def generate_questions(count=10):
    """ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù…ÙŠÙ‚Ø©"""
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù…ÙŠÙ‚Ø© ÙˆÙ…Ø«ÙŠØ±Ø© Ù„Ù„ØªÙÙƒÙŠØ± Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.

Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ {count} Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø© ØªØ´Ù…Ù„:
- Ø£Ø³Ø¦Ù„Ø© ÙÙ„Ø³ÙÙŠØ© Ø¹Ù…ÙŠÙ‚Ø©
- Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø¨
- Ø£Ø³Ø¦Ù„Ø© ØªØ­ÙØ² Ø§Ù„ØªØ£Ù…Ù„ Ø§Ù„Ø°Ø§ØªÙŠ
- Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø£Ø­Ù„Ø§Ù… ÙˆØ§Ù„Ø·Ù…ÙˆØ­Ø§Øª

Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:
âœ“ Ù…Ø®ØªÙ„ÙØ© ØªÙ…Ø§Ù…Ø§Ù‹
âœ“ Ø¹Ù…ÙŠÙ‚Ø© ÙˆÙ…Ø«ÙŠØ±Ø© Ù„Ù„ØªÙÙƒÙŠØ±
âœ“ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø§Ø±
âœ“ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¨Ø³ÙŠØ· ÙˆÙˆØ§Ø¶Ø­

Ø§ÙƒØªØ¨ ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„ Ø¨Ø¯ÙˆÙ† ØªØ±Ù‚ÙŠÙ…."""
    
    try:
        response = model.generate_content(prompt)
        questions = [q.strip() for q in response.text.strip().split('\n') if q.strip()]
        return questions[:count]
    except:
        return ["Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©"]

def generate_riddles(count=5):
    """ØªÙˆÙ„ÙŠØ¯ Ø£Ù„ØºØ§Ø²"""
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø£Ù„ØºØ§Ø² Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.

Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ {count} Ø£Ù„ØºØ§Ø² Ù…Ù…ØªØ¹Ø© ÙˆÙ…ØªÙ†ÙˆØ¹Ø©.

Ù„ÙƒÙ„ Ù„ØºØ²:
âœ“ Ø§ÙƒØªØ¨ Ø§Ù„Ù„ØºØ² ÙÙŠ Ø³Ø·Ø±
âœ“ Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ù„ ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ: [Ø§Ù„Ø­Ù„: ...]

Ù…Ø«Ø§Ù„:
Ø´ÙŠØ¡ Ù„Ù‡ Ø±Ø£Ø³ ÙˆÙ„ÙŠØ³ Ù„Ù‡ Ø¬Ø³Ø¯ØŸ
[Ø§Ù„Ø­Ù„: Ø§Ù„Ø¯Ø¨ÙˆØ³]

Ù„Ø§ ØªØ¶Ø¹ Ø£Ø±Ù‚Ø§Ù…ØŒ ÙÙ‚Ø· Ø§Ù„Ù„ØºØ² ÙˆØ§Ù„Ø­Ù„."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ù„ØºØ§Ø²"

def generate_games():
    """ØªÙˆÙ„ÙŠØ¯ Ø£ÙÙƒØ§Ø± Ø£Ù„Ø¹Ø§Ø¨"""
    prompt = """Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ø¨ØªÙƒØ§Ø± Ø£Ù„Ø¹Ø§Ø¨ ØªÙØ§Ø¹Ù„ÙŠØ©.

Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ 5 Ø£ÙÙƒØ§Ø± Ø£Ù„Ø¹Ø§Ø¨ ÙŠÙ…ÙƒÙ† Ù„Ø¹Ø¨Ù‡Ø§ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù†ØµÙŠØ©:
- Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ØªØ®Ù…ÙŠÙ†
- Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
- Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
- ØªØ­Ø¯ÙŠØ§Øª Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ©

Ù„ÙƒÙ„ Ù„Ø¹Ø¨Ø©:
âœ“ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©
âœ“ Ø´Ø±Ø­ Ø¨Ø³ÙŠØ·
âœ“ Ù…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹

Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø´Ø±Ø­ Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙ…Ù…ØªØ¹Ø§Ù‹."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨"

def chat_with_ai(user_message, history):
    """Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø§Ù…Ø© Ù…Ø¹ AI"""
    context = "\n".join([f"Ù…Ø³ØªØ®Ø¯Ù…: {h['user']}\nAI: {h['ai']}" for h in history[-3:]])
    
    prompt = f"""Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙˆØ¯ÙˆØ¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.

Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:
{context}

Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_message}

Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø±Ø¯:
âœ“ ÙƒÙ† ÙˆØ¯ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ø­ØªØ±Ù…Ø§Ù‹
âœ“ Ø£Ø³Ù„ÙˆØ¨ Ø¹Ø±Ø¨ÙŠ ÙØµÙŠØ­ ÙˆØ¨Ø³ÙŠØ·
âœ“ Ù…Ø¨Ø§Ø´Ø± ÙˆÙ…ÙÙŠØ¯
âœ“ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø§Ø¹ØªØ¯Ø§Ù„
âœ“ Ø±Ø¯ Ù‚ØµÙŠØ± (3-5 Ø£Ø³Ø·Ø±)"""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£"

@app.route("/", methods=["GET"])
def home():
    return "âœ… Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø¨ÙƒØ§Ù…Ù„ Ø·Ø§Ù‚ØªÙ‡!"

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature')
    if not signature:
        abort(400)
    
    body = request.get_data(as_text=True)
    
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    except Exception as e:
        print(f"Ø®Ø·Ø£: {e}")
        abort(500)
    
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip()
    data = get_user_data(user_id)
    
    # ÙØ­Øµ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹
    if "http://" in text.lower() or "https://" in text.lower():
        data['links_count'] += 1
        
        if data['links_count'] == 1:
            return
        
        if data['links_count'] >= 2:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="âš ï¸ ØªØ­Ø°ÙŠØ±\n\nÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø±")
            )
        return
    
    text_lower = text.lower()
    reply_text = ""
    
    # Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    if any(word in text_lower for word in ["Ù…Ø³Ø§Ø¹Ø¯Ø©", "Ù…Ø³Ø§Ø¹Ø¯Ù‡", "help", "Ø§Ù„Ø§ÙˆØ§Ù…Ø±", "Ø§Ù„Ø£ÙˆØ§Ù…Ø±", "Ø§ÙˆØ§Ù…Ø±"]):
        reply_text = """ðŸ¤– Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ

ðŸ“‹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:

ðŸ’­ Ø³Ø¤Ø§Ù„ - Ø£Ø³Ø¦Ù„Ø© Ø¹Ù…ÙŠÙ‚Ø© Ù„Ù„ØªÙÙƒÙŠØ±
ðŸ§© Ù„ØºØ² - Ø£Ù„ØºØ§Ø² Ù„ØªØ­Ø¯ÙŠ Ø¹Ù‚Ù„Ùƒ
ðŸŽ® Ù„Ø¹Ø¨Ø© - Ø£Ù„Ø¹Ø§Ø¨ ØªÙØ§Ø¹Ù„ÙŠØ©
ðŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø© - Ø§Ø®ØªØ¨Ø§Ø± Ù†ÙØ³ÙŠ Ø´Ø§Ù…Ù„
ðŸŽ¨ Ù„ÙˆÙ†ÙŠ - ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„
â™ˆ Ø¨Ø±Ø¬ÙŠ - ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø¨Ø±Ø¬Ùƒ Ø§Ù„ÙÙ„ÙƒÙŠ
ðŸŽ‚ Ø´Ù‡Ø± Ù…ÙŠÙ„Ø§Ø¯ÙŠ - ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø´Ù‡Ø± Ù…ÙŠÙ„Ø§Ø¯Ùƒ
ðŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø±Ø© - Ø§ÙƒØªØ¨ Ø£ÙŠ Ø´ÙŠØ¡

Ø§Ø³ØªÙ…ØªØ¹! âœ¨"""
    
    # Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    elif any(word in text_lower for word in ["Ø³Ø¤Ø§Ù„", "Ø§Ø³Ø¦Ù„Ø©", "Ø£Ø³Ø¦Ù„Ø©", "Ø§Ø³Ø§Ù„Ù‡", "Ø³ÙˆØ§Ù„"]):
        questions = generate_questions(10)
        reply_text = "ðŸ’­ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù…ÙŠÙ‚Ø© Ù„Ù„ØªÙÙƒÙŠØ±\n\n"
        reply_text += "\n\n".join([f"â€¢ {q}" for q in questions])
        reply_text += "\n\nâœ¨ Ø®Ø° ÙˆÙ‚ØªÙƒ ÙÙŠ Ø§Ù„ØªØ£Ù…Ù„"
    
    # Ø§Ù„Ø£Ù„ØºØ§Ø²
    elif any(word in text_lower for word in ["Ù„ØºØ²", "Ø§Ù„ØºØ§Ø²", "Ø£Ù„ØºØ§Ø²"]):
        riddles = generate_riddles(5)
        reply_text = f"ðŸ§© Ø£Ù„ØºØ§Ø² Ù„ØªØ­Ø¯ÙŠ Ø¹Ù‚Ù„Ùƒ\n\n{riddles}\n\nðŸ¤” Ù‡Ù„ Ø§Ø³ØªØ·Ø¹Øª Ø­Ù„Ù‡Ø§ØŸ"
    
    # Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
    elif any(word in text_lower for word in ["Ù„Ø¹Ø¨Ø©", "Ø§Ù„Ø¹Ø§Ø¨", "Ø£Ù„Ø¹Ø§Ø¨", "Ù„Ø¹Ø¨"]):
        games = generate_games()
        reply_text = f"ðŸŽ® Ø£Ù„Ø¹Ø§Ø¨ ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ù…ØªØ¹Ø©\n\n{games}\n\nðŸŽ¯ Ø¬Ø±Ø¨ ÙˆØ§Ø³ØªÙ…ØªØ¹!"
    
    # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©
    elif any(word in text_lower for word in ["Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©", "Ø§Ù„ØºØ§Ø¨Ø©", "Ø§Ø®ØªØ¨Ø§Ø± Ù†ÙØ³ÙŠ"]):
        if data['test_mode'] == 'forest':
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
            analysis = analyze_forest_test(text)
            reply_text = f"ðŸŒ² ØªØ­Ù„ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©\n\n{analysis}\n\nâœ¨ Ù‡Ø°Ø§ ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ù…ØªØ¹Ø© ÙˆØ§Ù„ØªØ³Ù„ÙŠØ©"
            data['test_mode'] = None
        else:
            # Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            reply_text = FOREST_TEST
            data['test_mode'] = 'forest'
    
    # ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ù„ÙˆÙ†
    elif any(word in text_lower for word in ["Ù„ÙˆÙ†ÙŠ", "Ù„ÙˆÙ†", "ØªØ­Ù„ÙŠÙ„ Ù„ÙˆÙ†", "Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ÙØ¶Ù„"]):
        if data['test_mode'] == 'color':
            analysis = analyze_by_color(text)
            reply_text = f"ðŸŽ¨ ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØªÙƒ Ù…Ù† Ø§Ù„Ù„ÙˆÙ†\n\n{analysis}"
            data['test_mode'] = None
        else:
            reply_text = "ðŸŽ¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ÙØ¶Ù„\n\nÙ…Ø§ Ù‡Ùˆ Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ\nØ§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ† (Ù…Ø«Ø§Ù„: Ø£Ø²Ø±Ù‚ØŒ Ø£Ø­Ù…Ø±ØŒ Ø£Ø®Ø¶Ø±ØŒ Ø£ØµÙØ±...)"
            data['test_mode'] = 'color'
    
    # ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨Ø±Ø¬
    elif any(word in text_lower for word in ["Ø¨Ø±Ø¬ÙŠ", "Ø¨Ø±Ø¬", "ØªØ­Ù„ÙŠÙ„ Ø¨Ø±Ø¬", "Ø§Ù„Ø§Ø¨Ø±Ø§Ø¬"]):
        if data['test_mode'] == 'zodiac':
            analysis = analyze_by_zodiac(text)
            reply_text = f"â™ˆ ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØªÙƒ Ù…Ù† Ø§Ù„Ø¨Ø±Ø¬\n\n{analysis}"
            data['test_mode'] = None
        else:
            reply_text = """â™ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø±Ø¬

Ù…Ø§ Ù‡Ùˆ Ø¨Ø±Ø¬ÙƒØŸ

Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©:
â™ˆ Ø§Ù„Ø­Ù…Ù„ | â™‰ Ø§Ù„Ø«ÙˆØ± | â™Š Ø§Ù„Ø¬ÙˆØ²Ø§Ø¡
â™‹ Ø§Ù„Ø³Ø±Ø·Ø§Ù† | â™Œ Ø§Ù„Ø£Ø³Ø¯ | â™ Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡
â™Ž Ø§Ù„Ù…ÙŠØ²Ø§Ù† | â™ Ø§Ù„Ø¹Ù‚Ø±Ø¨ | â™ Ø§Ù„Ù‚ÙˆØ³
â™‘ Ø§Ù„Ø¬Ø¯ÙŠ | â™’ Ø§Ù„Ø¯Ù„Ùˆ | â™“ Ø§Ù„Ø­ÙˆØª"""
            data['test_mode'] = 'zodiac'
    
    # ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯
    elif any(word in text_lower for word in ["Ø´Ù‡Ø± Ù…ÙŠÙ„Ø§Ø¯ÙŠ", "Ø´Ù‡Ø± Ù…ÙŠÙ„Ø§Ø¯", "Ù…ÙŠÙ„Ø§Ø¯ÙŠ", "ØªØ­Ù„ÙŠÙ„ Ø´Ù‡Ø±"]):
        if data['test_mode'] == 'birth_month':
            analysis = analyze_by_birth_month(text)
            reply_text = f"ðŸŽ‚ ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØªÙƒ Ù…Ù† Ø´Ù‡Ø± Ù…ÙŠÙ„Ø§Ø¯Ùƒ\n\n{analysis}"
            data['test_mode'] = None
        else:
            reply_text = """ðŸŽ‚ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯

ÙÙŠ Ø£ÙŠ Ø´Ù‡Ø± ÙˆÙ„Ø¯ØªØŸ

Ø§Ù„Ø´Ù‡ÙˆØ±:
ÙŠÙ†Ø§ÙŠØ± | ÙØ¨Ø±Ø§ÙŠØ± | Ù…Ø§Ø±Ø³
Ø£Ø¨Ø±ÙŠÙ„ | Ù…Ø§ÙŠÙˆ | ÙŠÙˆÙ†ÙŠÙˆ
ÙŠÙˆÙ„ÙŠÙˆ | Ø£ØºØ³Ø·Ø³ | Ø³Ø¨ØªÙ…Ø¨Ø±
Ø£ÙƒØªÙˆØ¨Ø± | Ù†ÙˆÙÙ…Ø¨Ø± | Ø¯ÙŠØ³Ù…Ø¨Ø±"""
            data['test_mode'] = 'birth_month'
    
    # Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯
    elif data['test_mode']:
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹
        if data['test_mode'] == 'forest':
            analysis = analyze_forest_test(text)
            reply_text = f"ðŸŒ² ØªØ­Ù„ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©\n\n{analysis}\n\nâœ¨ Ù„Ù„Ù…ØªØ¹Ø© ÙˆØ§Ù„ØªØ³Ù„ÙŠØ©"
            data['test_mode'] = None
        elif data['test_mode'] == 'color':
            analysis = analyze_by_color(text)
            reply_text = f"ðŸŽ¨ ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ù„ÙˆÙ†\n\n{analysis}"
            data['test_mode'] = None
        elif data['test_mode'] == 'zodiac':
            analysis = analyze_by_zodiac(text)
            reply_text = f"â™ˆ ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨Ø±Ø¬\n\n{analysis}"
            data['test_mode'] = None
        elif data['test_mode'] == 'birth_month':
            analysis = analyze_by_birth_month(text)
            reply_text = f"ðŸŽ‚ ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø´Ù‡Ø± Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯\n\n{analysis}"
            data['test_mode'] = None
    
    # Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø§Ù…Ø©
    else:
        ai_response = chat_with_ai(text, data['conversation_history'])
        reply_text = ai_response
        
        data['conversation_history'].append({
            'user': text,
            'ai': ai_response
        })
        
        if len(data['conversation_history']) > 10:
            data['conversation_history'] = data['conversation_history'][-10:]
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
    if reply_text:
        if len(reply_text) > 4500:
            messages = [reply_text[i:i+4500] for i in range(0, len(reply_text), 4500)]
            line_bot_api.reply_message(
                event.reply_token,
                [TextSendMessage(text=msg) for msg in messages[:5]]
            )
        else:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=reply_text)
            )

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port, debug=False)
