import os
from flask import Flask, request, jsonify
import openai

app = Flask(__name__)

# --- ุงูุชุญูู ูู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ---
required_env_vars = [
    "OPENAI_API_KEY",
    "GENAI_API_KEY",
    "LINE_CHANNEL_ACCESS_TOKEN",
    "LINE_CHANNEL_SECRET"
]

missing_vars = [var for var in required_env_vars if not os.environ.get(var)]
if missing_vars:
    print(f"โ๏ธ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ุงููุงูุตุฉ: {', '.join(missing_vars)}")
else:
    print("โ ุฌููุน ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ููุฌูุฏุฉ.")

# --- ุฅุนุฏุงุฏ ุงููููุฐ ููู Render ---
port = int(os.environ.get("PORT", 5000))

# --- ุฃูุฑ ุงููุณุงุนุฏุฉ ---
commands_help = """
ุฃูุงูุฑ ุงูุจูุช ุงููุชูุฏูุฉ:

1. ูุณุงุนุฏุฉ
   - ููุถุญ ูู ุงูุฃูุงูุฑ ูุทุฑููุฉ ุงุณุชุฎุฏุงููุง.

2. ุชุนูู ุงูุฅูุฌููุฒูุฉ ุจุทุฑููุฉ ูุนุจุฉ
   - ุฃุณุฆูุฉ ุชูุงุนููุฉ ููุฃุทูุงูุ ุฎูุงุฑุงุช ูุชุตุญูุญ ุชููุงุฆู.

3. ูุถูุถุฉ ุงููุดุงุนุฑ
   - ุชุญุฏุซ ุนู ูุดุงุนุฑูุ ุณุชุญุตู ุนูู ูุตุงุฆุญ ูุญููู.

4. ุฅูุดุงุก ุตูุฑ AI
   - ูุตู ุงูุตูุฑุฉ ูุณูุนุทูู ุฃูุฑ ุงุญุชุฑุงูู ูู Canva ุฃู ุฃู ูููุน AI.

5. ุฅูุดุงุก ููุฏูููุงุช AI
   - ูุตู ุงูููุฏูู ูุณูุชู ุฅูุดุงุก ุฃูุฑ ุฅูุชุงุฌ ุฌุงูุฒ.

6. ุฅูุดุงุก ุนุฑูุถ ุชูุฏูููุฉ
   - ุงูุชุจ ุงูููุถูุน ูุณูุชู ุชูููุฏ ุดุฑุงุฆุญ ุนุฑุถ ุชููุงุฆูุงู.

7. ูุชุงุจุฉ ูุชุตุญูุญ ุงูุฃููุงุฏ
   - ุฃุฑุณู ุงูููุฏ ูุณูุชู ุชุตุญูุญู ุฃู ุฅูุดุงุคู ุฌุฏูุฏ.

8. ุญู ุงููุงุฌุจุงุช ูุงูุงุฎุชุจุงุฑุงุช
   - ุงูุชุจ ุงูุตู ูุงููุงุฏุฉ ูุงูุตูุญุฉ ููุญุตูู ุนูู ุญููู ุฃู ููุฎุตุงุช.

9. ุฅูุดุงุก ุฃู ุฃูุฑ ูุฎุตุต
   - ุงุทูุจ ุฃู ุดูุก: ูุชุจุ ุตูุฑุ ููุฏููุ ุนุฑูุถุ AI ูุณูุชู ุชูููุฏ ุฃูุฑ ุงุญุชุฑุงูู.
"""

# --- ุญุงูุฉ ุงูุฃูุนุงุจ ุงูุชุนููููุฉ ---
english_game_state = {}

# --- ุฏุงูุฉ ุงูุฑุฏ ุนูู ุงูุฑุณุงุฆู ---
@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    user_id = data.get("user_id")
    user_message = data.get("message", "").strip().lower()

    # ุฃูุฑ ุงููุณุงุนุฏุฉ
    if "ูุณุงุนุฏุฉ" in user_message:
        return jsonify({"reply": commands_help})

    # ูุนุจุฉ ุชุนูู ุงูุฅูุฌููุฒูุฉ
    elif "ุชุนูู ุงูุฅูุฌููุฒูุฉ" in user_message:
        english_game_state[user_id] = {"level": "beginner", "question": 1}
        reply = ("๐ฎ ููุจุฏุฃ ูุนุจุฉ ุชุนูู ุงูุฅูุฌููุฒูุฉ! "
                 "ุงุฎุชุฑ ูุณุชูู: ูุจุชุฏุฆุ ูุชูุณุทุ ูุชูุฏู.\n"
                 "ุงูุชุจ: ูุณุชูู <ุงุณู ุงููุณุชูู>")
        return jsonify({"reply": reply})

    elif user_message.startswith("ูุณุชูู"):
        level = user_message.split(" ")[1] if len(user_message.split(" ")) > 1 else "beginner"
        english_game_state[user_id]["level"] = level
        english_game_state[user_id]["question"] = 1
        reply = f"๐น ุชู ุงุฎุชูุงุฑ ุงููุณุชูู {level}. ููุจุฏุฃ ุงูุณุคุงู ุงูุฃูู!"
        return jsonify({"reply": reply})

    elif user_message.startswith("ุฅุฌุงุจุฉ"):
        question_num = english_game_state[user_id].get("question", 1)
        english_game_state[user_id]["question"] += 1
        reply = f"โ ุฅุฌุงุจุชู ุนูู ุงูุณุคุงู {question_num} ูุณุฌูุฉ! ุงูุณุคุงู ุงูุชุงูู..."
        return jsonify({"reply": reply})

    # ูุถูุถุฉ ุงููุดุงุนุฑ
    elif "ูุถูุถุฉ" in user_message:
        reply = "๐ฌ ูุถูุถุฉ ููุจููุฉ! ุฃุฎุจุฑูู ุนู ุดุนูุฑูุ ูุณุฃุนุทูู ูุตุงุฆุญ ูุญููู."
        return jsonify({"reply": reply})

    # ุฅูุดุงุก ุตูุฑ AI
    elif "ุตูุฑุฉ ai" in user_message:
        reply = "๐ผ๏ธ ุงูุชุจ ูุตู ุงูุตูุฑุฉ ุงูุชู ุชุฑูุฏ ุฅูุดุงุคูุงุ ูุณุฃุนุทูู ุฃูุฑ ุงุญุชุฑุงูู ูู Canva ุฃู ุฃู ูููุน AI."
        return jsonify({"reply": reply})

    # ุฅูุดุงุก ููุฏูู AI
    elif "ููุฏูู ai" in user_message:
        reply = "๐ฌ ุงูุชุจ ูุตู ุงูููุฏูู ุงูุฐู ุชุฑูุฏ ุฅูุชุงุฌูุ ูุณูุชู ุชูููุฏ ุฃูุฑ ุฌุงูุฒ."
        return jsonify({"reply": reply})

    # ุฅูุดุงุก ุนุฑูุถ ุชูุฏูููุฉ
    elif "ุนุฑุถ ุชูุฏููู" in user_message:
        reply = "๐ ุงูุชุจ ููุถูุน ุงูุนุฑุถ ูุณูุชู ุชูููุฏ ุดุฑุงุฆุญ ุนุฑุถ ุงุญุชุฑุงููุฉ ุชููุงุฆูุงู."
        return jsonify({"reply": reply})

    # ูุชุงุจุฉ ูุชุตุญูุญ ุงูุฃููุงุฏ
    elif "ููุฏ" in user_message or "ุชุตุญูุญ ููุฏ" in user_message:
        reply = "๐ป ุฃุฑุณู ูู ุงูููุฏ ุงูุฐู ุชุฑูุฏ ูุชุงุจุชู ุฃู ุชุตุญูุญูุ ูุณุฃุณุงุนุฏู ููุฑุงู."
        return jsonify({"reply": reply})

    # ุญู ุงููุงุฌุจุงุช ูุงูุงุฎุชุจุงุฑุงุช
    elif "ูุงุฌุจ" in user_message or "ุงุฎุชุจุงุฑ" in user_message:
        reply = "๐ ุงูุชุจ ุงูุตู ูุงููุงุฏุฉ ูุงูุตูุญุฉุ ูุณุฃุนุทูู ุญููู ุฃู ููุฎุตุงุช ุฌุงูุฒุฉ."
        return jsonify({"reply": reply})

    # ุฅูุดุงุก ุฃู ุฃูุฑ ูุฎุตุต
    elif "ุฅูุดุงุก ุฃูุฑ" in user_message:
        reply = "โก ุงูุชุจ ูู ูุง ุชุฑูุฏุ ูุณุฃูุดุฆ ูู ุฃูุฑ ุงุญุชุฑุงูู ูุฃู ุงุณุชุฎุฏุงู: ูุชุจุ ุตูุฑุ ููุฏููุ ุนุฑูุถุ AI."
        return jsonify({"reply": reply})

    else:
        return jsonify({"reply": "ุชู ุงุณุชูุงู ุฑุณุงูุชูุ ุฌุงุฑู ุงููุนุงูุฌุฉ... ุงูุชุจ 'ูุณุงุนุฏุฉ' ูุนุฑุถ ูู ุงูุฃูุงูุฑ."})

# --- ุชุดุบูู ุงูุณูุฑูุฑ ---
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=port)
