from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os
import google.generativeai as genai
import re

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

if not all([LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET, GEMINI_API_KEY]):
    raise ValueError("ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-pro')

user_data = {}

FOREST_QUESTIONS = [
    {"question": "ğŸŒ² ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ ØªÙ…Ø´ÙŠ ÙÙŠ ØºØ§Ø¨Ø©... Ø§Ù†Ø¸Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±:", "options": ["1ï¸âƒ£ Ù…Ù†Ø¸Ù…Ø© ÙˆÙ…Ø±ØªØ¨Ø© Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„", "2ï¸âƒ£ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙˆÙ…ØªÙ†Ø§Ø«Ø±Ø© Ø¨Ø­Ø±ÙŠØ©", "3ï¸âƒ£ Ø¨Ø¹Ø¶Ù‡Ø§ Ù…Ù†Ø¸Ù… ÙˆØ¨Ø¹Ø¶Ù‡Ø§ Ø¹Ø´ÙˆØ§Ø¦ÙŠ", "4ï¸âƒ£ ÙƒØ«ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ ÙŠØµØ¹Ø¨ Ø±Ø¤ÙŠØªÙ‡Ø§"]},
    {"question": "ğŸŒ… Ù…Ø§ Ù‡Ùˆ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø©ØŸ", "options": ["1ï¸âƒ£ Ù†Ù‡Ø§Ø± Ù…Ø´Ø±Ù‚ ÙˆÙˆØ§Ø¶Ø­", "2ï¸âƒ£ Ù„ÙŠÙ„ Ù…Ø¸Ù„Ù… ÙˆÙ…Ø®ÙŠÙ", "3ï¸âƒ£ ØºØ±ÙˆØ¨ Ø§Ù„Ø´Ù…Ø³ (Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‡Ø§Ø± ÙˆØ§Ù„Ù„ÙŠÙ„)", "4ï¸âƒ£ ÙØ¬Ø± Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø±)"]},
    {"question": "ğŸ›¤ï¸ ÙƒÙŠÙ ÙŠØ¨Ø¯Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ø£Ù…Ø§Ù…ÙƒØŸ", "options": ["1ï¸âƒ£ ÙˆØ§Ø³Ø¹ ÙˆÙˆØ§Ø¶Ø­ Ø¬Ø¯Ø§Ù‹", "2ï¸âƒ£ Ø¶ÙŠÙ‚ ÙˆÙ…Ø­Ø¯ÙˆØ¯", "3ï¸âƒ£ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø±Ø¶", "4ï¸âƒ£ ØºÙŠØ± ÙˆØ§Ø¶Ø­ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹"]},
    {"question": "ğŸ”‘ ØªØ±Ù‰ Ù…ÙØªØ§Ø­Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶... ÙƒÙŠÙ ÙŠØ¨Ø¯ÙˆØŸ", "options": ["1ï¸âƒ£ Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ø§Ù…Ø¹", "2ï¸âƒ£ Ù‚Ø¯ÙŠÙ… ÙˆØµØ¯Ø¦", "3ï¸âƒ£ Ø°Ù‡Ø¨ÙŠ ÙˆØ«Ù…ÙŠÙ†", "4ï¸âƒ£ Ø¹Ø§Ø¯ÙŠ ÙˆØ¨Ø³ÙŠØ·"]},
    {"question": "ğŸ”‘ Ù…Ø§Ø°Ø§ Ø³ØªÙØ¹Ù„ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ØŸ", "options": ["1ï¸âƒ£ Ø³Ø¢Ø®Ø°Ù‡ Ù…Ø¹ÙŠ ÙÙˆØ±Ø§Ù‹", "2ï¸âƒ£ Ø³Ø£ØªØ±ÙƒÙ‡ Ù…ÙƒØ§Ù†Ù‡", "3ï¸âƒ£ Ø³Ø£ÙÙƒØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø¢Ø®Ø°Ù‡", "4ï¸âƒ£ Ø³Ø£Ù†Ø¸Ø± Ø¥Ù„ÙŠÙ‡ ÙÙ‚Ø· ÙˆØ£ÙƒÙ…Ù„"]},
    {"question": "ğŸ» ÙŠØ¸Ù‡Ø± Ø¯Ø¨ Ø£Ù…Ø§Ù…Ùƒ... ÙƒÙŠÙ Ù‡ÙˆØŸ", "options": ["1ï¸âƒ£ ÙˆØ¯ÙˆØ¯ ÙˆÙ„Ø·ÙŠÙ", "2ï¸âƒ£ Ø¹Ø¯ÙˆØ§Ù†ÙŠ ÙˆÙ…Ø®ÙŠÙ", "3ï¸âƒ£ Ù…Ø­Ø§ÙŠØ¯ ÙˆÙŠØ±Ø§Ù‚Ø¨Ù†ÙŠ", "4ï¸âƒ£ Ø®Ø§Ø¦Ù ÙˆÙŠÙ‡Ø±Ø¨ Ù…Ù†ÙŠ"]},
    {"question": "ğŸ» Ù…Ø§ Ø­Ø¬Ù… Ø§Ù„Ø¯Ø¨ØŸ", "options": ["1ï¸âƒ£ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ¨Ø± Ù…Ù†ÙŠ)", "2ï¸âƒ£ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ù…", "3ï¸âƒ£ ØµØºÙŠØ± (Ø£ØµØºØ± Ù…Ù†ÙŠ)", "4ï¸âƒ£ Ø¹Ù…Ù„Ø§Ù‚ Ø¶Ø®Ù…"]},
    {"question": "ğŸº ØªØ¬Ø¯ Ø¬Ø±Ø© ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚... Ù…Ù…Ø§ Ù‡ÙŠ Ù…ØµÙ†ÙˆØ¹Ø©ØŸ", "options": ["1ï¸âƒ£ Ø®Ø´Ø¨ Ù‚Ø¯ÙŠÙ…", "2ï¸âƒ£ ÙØ®Ø§Ø± ØªÙ‚Ù„ÙŠØ¯ÙŠ", "3ï¸âƒ£ Ø²Ø¬Ø§Ø¬ Ø´ÙØ§Ù", "4ï¸âƒ£ Ù…Ø¹Ø¯Ù† Ù„Ø§Ù…Ø¹"]},
    {"question": "ğŸº Ù…Ø§Ø°Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø±Ø©ØŸ", "options": ["1ï¸âƒ£ Ù…Ø§Ø¡ Ù†Ù‚ÙŠ", "2ï¸âƒ£ ÙƒÙ†Ø² ÙˆØ°Ù‡Ø¨", "3ï¸âƒ£ ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹", "4ï¸âƒ£ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ°ÙƒØ±ÙŠØ§Øª"]},
    {"question": "ğŸ  ÙŠØ¸Ù‡Ø± Ù…Ù†Ø²Ù„... ÙƒÙŠÙ ÙŠØ¨Ø¯ÙˆØŸ", "options": ["1ï¸âƒ£ Ù‚ØµØ± ÙƒØ¨ÙŠØ± ÙˆÙØ®Ù…", "2ï¸âƒ£ ÙƒÙˆØ® ØµØºÙŠØ± ÙˆØ¯Ø§ÙØ¦", "3ï¸âƒ£ Ù…Ù†Ø²Ù„ Ø¹Ø§Ø¯ÙŠ Ù…ØªÙˆØ³Ø·", "4ï¸âƒ£ Ù‚Ù„Ø¹Ø© Ù…Ø­ØµÙ†Ø©"]},
    {"question": "ğŸšª ØªØ³Ù…Ø¹ Ø±Ø¬Ù„Ø§Ù‹ ÙŠØµØ±Ø® Ù…Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ ÙŠØ·Ù„Ø¨ ÙØªØ­ Ø§Ù„Ø¨Ø§Ø¨:", "options": ["1ï¸âƒ£ Ø³Ø£ÙØªØ­ Ø§Ù„Ø¨Ø§Ø¨ ÙÙˆØ±Ø§Ù‹", "2ï¸âƒ£ Ù„Ù† Ø£ÙØªØ­ Ø£Ø¨Ø¯Ø§Ù‹", "3ï¸âƒ£ Ø³Ø£Ø³Ø£Ù„ Ù…Ù† Ù‡Ùˆ Ø£ÙˆÙ„Ø§Ù‹", "4ï¸âƒ£ Ø³Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø®Ù„ Ø¢Ø®Ø±"]},
    {"question": "â¬œ ÙŠØµØ¨Ø­ ÙƒÙ„ Ø´ÙŠØ¡ Ø£Ø¨ÙŠØ¶ ÙØ¬Ø£Ø©... Ù…Ø§Ø°Ø§ Ø³ØªÙØ¹Ù„ØŸ", "options": ["1ï¸âƒ£ Ø³Ø£Ø³ØªØ³Ù„Ù… ÙˆØ£Ù†ØªØ¸Ø±", "2ï¸âƒ£ Ø³Ø£Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø´ÙŠ", "3ï¸âƒ£ Ø³Ø£ØµØ±Ø® Ø·Ù„Ø¨Ø§Ù‹ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©", "4ï¸âƒ£ Ø³Ø£Ø¬Ù„Ø³ ÙˆØ£ÙÙƒØ± Ø¨Ù‡Ø¯ÙˆØ¡"]}
]

PERSONALITY_GAMES = """ğŸ® Ø£Ù„Ø¹Ø§Ø¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©

Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©:

1ï¸âƒ£ ğŸï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ù…Ù‡Ø¬ÙˆØ±Ø©
2ï¸âƒ£ ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ù…Ø³Ø©
3ï¸âƒ£ ğŸšª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
4ï¸âƒ£ ğŸŒŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ø¹Ù…ÙŠÙ‚
5ï¸âƒ£ ğŸ­ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø±Ø¢Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©
6ï¸âƒ£ ğŸ° Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„ØºØ§Ù…Ø¶Ø©
7ï¸âƒ£ ğŸŒŸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ø³Ø¨Ø¹Ø©

Ù…Ø«Ø§Ù„: Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø· (1)"""

ISLAND_QUESTIONS = [
    {"question": "ğŸï¸ Ø£Ù†Øª Ø¹Ù„Ù‰ Ø¬Ø²ÙŠØ±Ø© Ù…Ù‡Ø¬ÙˆØ±Ø©... Ù…Ø§ Ø£ÙˆÙ„ Ø´ÙŠØ¡ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡ØŸ", "options": ["1ï¸âƒ£ Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„Ø·Ø¹Ø§Ù…", "2ï¸âƒ£ Ù…ÙƒØ§Ù† Ø¢Ù…Ù† Ù„Ù„Ù†ÙˆÙ…", "3ï¸âƒ£ Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ù‡Ø±Ø¨", "4ï¸âƒ£ Ø£Ø´Ø®Ø§Øµ Ø¢Ø®Ø±ÙŠÙ†"]},
    {"question": "ğŸŒ´ ØªØ±Ù‰ Ø´Ø¬Ø±Ø© Ø¶Ø®Ù…Ø©... Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options": ["1ï¸âƒ£ Ø£ØªØ³Ù„Ù‚Ù‡Ø§ Ù„Ø£Ø±Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†", "2ï¸âƒ£ Ø£Ø³ØªØ±ÙŠØ­ ØªØ­Øª Ø¸Ù„Ù‡Ø§", "3ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ø«Ù…Ø§Ø± Ø¹Ù„ÙŠÙ‡Ø§", "4ï¸âƒ£ Ø£ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ ÙˆØ£ÙƒÙ…Ù„"]},
    {"question": "ğŸ“¦ ØªØ¬Ø¯ ØµÙ†Ø¯ÙˆÙ‚Ø§Ù‹ Ù…ØºÙ„Ù‚Ø§Ù‹... Ù…Ø§Ø°Ø§ ØªØªÙˆÙ‚Ø¹ Ø¨Ø¯Ø§Ø®Ù„Ù‡ØŸ", "options": ["1ï¸âƒ£ Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù†Ø¬Ø§Ø©", "2ï¸âƒ£ ÙƒÙ†Ø² Ø«Ù…ÙŠÙ†", "3ï¸âƒ£ Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø¬Ø²ÙŠØ±Ø©", "4ï¸âƒ£ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø£Ø­Ø¯Ù‡Ù…"]},
    {"question": "ğŸŒŠ ØªØ³Ù…Ø¹ ØµÙˆØª Ø£Ù…ÙˆØ§Ø¬... Ù…Ø§Ø°Ø§ ØªØ´Ø¹Ø±ØŸ", "options": ["1ï¸âƒ£ Ù‡Ø¯ÙˆØ¡ ÙˆØ³ÙƒÙŠÙ†Ø©", "2ï¸âƒ£ Ø®ÙˆÙ ÙˆÙ‚Ù„Ù‚", "3ï¸âƒ£ Ø­Ù…Ø§Ø³ ÙˆÙØ¶ÙˆÙ„", "4ï¸âƒ£ Ø­Ø²Ù† ÙˆØ­Ù†ÙŠÙ†"]},
    {"question": "ğŸ”¥ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø´Ø¹Ø§Ù„ Ù†Ø§Ø±... ÙƒÙŠÙ ØªØ¨Ø¯Ø£ØŸ", "options": ["1ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ø£Ø­Ø¬Ø§Ø± ØµÙˆØ§Ù†", "2ï¸âƒ£ Ø£Ø­Ø§ÙˆÙ„ Ø¨Ø§Ù„Ø¹ØµÙŠ ÙˆØ§Ù„Ø§Ø­ØªÙƒØ§Ùƒ", "3ï¸âƒ£ Ø£Ù†ØªØ¸Ø± Ø­ØªÙ‰ Ø£Ø¬Ø¯ Ø£Ø¯Ø§Ø©", "4ï¸âƒ£ Ø£Ø³ØªØ®Ø¯Ù… Ø¹Ø¯Ø³Ø© Ø£Ùˆ Ø²Ø¬Ø§Ø¬"]},
    {"question": "ğŸš ØªØ¬Ø¯ Ù…Ø­Ø§Ø±Ø© ÙƒØ¨ÙŠØ±Ø©... Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ Ø¨Ù‡Ø§ØŸ", "options": ["1ï¸âƒ£ Ø£Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙƒÙˆØ¹Ø§Ø¡ Ù„Ù„Ù…Ø§Ø¡", "2ï¸âƒ£ Ø£Ø­ØªÙØ¸ Ø¨Ù‡Ø§ ÙƒØªØ°ÙƒØ§Ø±", "3ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ù„Ø¤Ù„Ø¤Ø© Ø¨Ø¯Ø§Ø®Ù„Ù‡Ø§", "4ï¸âƒ£ Ø£ØªØ±ÙƒÙ‡Ø§ Ù…ÙƒØ§Ù†Ù‡Ø§"]},
    {"question": "ğŸŒ™ Ø­Ù„ Ø§Ù„Ù„ÙŠÙ„... ÙƒÙŠÙ ØªÙ‚Ø¶ÙŠÙ‡ØŸ", "options": ["1ï¸âƒ£ Ø£Ù†Ø§Ù… Ù…Ø¨ÙƒØ±Ø§Ù‹ Ù„Ø£Ø³ØªØ±ÙŠØ­", "2ï¸âƒ£ Ø£Ø¨Ù‚Ù‰ Ù…Ø³ØªÙŠÙ‚Ø¸Ø§Ù‹ Ø­Ø°Ø±Ø§Ù‹", "3ï¸âƒ£ Ø£Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ£ÙÙƒØ±", "4ï¸âƒ£ Ø£Ø­Ø§ÙˆÙ„ ØµÙŠØ¯ Ø§Ù„Ø³Ù…Ùƒ"]},
    {"question": "ğŸ¦œ ØªØ¸Ù‡Ø± Ø·ÙŠÙˆØ± Ù…Ù„ÙˆÙ†Ø©... Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options": ["1ï¸âƒ£ Ø£ØªØ¨Ø¹Ù‡Ø§ Ù„Ø¹Ù„Ù‡Ø§ ØªÙ‚ÙˆØ¯Ù†ÙŠ Ù„Ø´ÙŠØ¡", "2ï¸âƒ£ Ø£Ø­Ø§ÙˆÙ„ Ø§ØµØ·ÙŠØ§Ø¯Ù‡Ø§ Ù„Ù„Ø·Ø¹Ø§Ù…", "3ï¸âƒ£ Ø£Ø³ØªÙ…ØªØ¹ Ø¨Ø¬Ù…Ø§Ù„Ù‡Ø§ ÙÙ‚Ø·", "4ï¸âƒ£ Ø£Ø³ØªØ®Ø¯Ù… Ø±ÙŠØ´Ù‡Ø§ Ù„Ù„Ø²ÙŠÙ†Ø©"]},
    {"question": "â›µ ØªØ±Ù‰ Ù‚Ø§Ø±Ø¨Ø§Ù‹ Ù‚Ø¯ÙŠÙ…Ø§Ù‹... Ù…Ø§Ø°Ø§ ØªÙ‚Ø±Ø±ØŸ", "options": ["1ï¸âƒ£ Ø£ØµÙ„Ø­Ù‡ ÙˆØ£Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø¨Ø­Ø§Ø±", "2ï¸âƒ£ Ø£Ø³ØªØ®Ø¯Ù… Ø£Ø¬Ø²Ø§Ø¡Ù‡ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø£ÙˆÙ‰", "3ï¸âƒ£ Ø£Ø¨Ø­Ø« ÙÙŠÙ‡ Ø¹Ù† Ø£Ø´ÙŠØ§Ø¡ Ù…ÙÙŠØ¯Ø©", "4ï¸âƒ£ Ø£ØªØ±ÙƒÙ‡ ÙÙ‚Ø¯ ÙŠÙƒÙˆÙ† Ø®Ø·Ø±Ø§Ù‹"]},
    {"question": "ğŸ†˜ ØªØ£ØªÙŠ Ø·Ø§Ø¦Ø±Ø© Ø¥Ù†Ù‚Ø§Ø°... ÙƒÙŠÙ ØªØªØµØ±ÙØŸ", "options": ["1ï¸âƒ£ Ø£Ø´Ø¹Ù„ Ù†Ø§Ø± ÙƒØ¨ÙŠØ±Ø© Ù„Ù„Ø¥Ø´Ø§Ø±Ø©", "2ï¸âƒ£ Ø£ØµØ±Ø® ÙˆØ£Ù„ÙˆØ­ Ø¨Ù‚ÙˆØ©", "3ï¸âƒ£ Ø£ÙƒØªØ¨ SOS Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø·Ø¦", "4ï¸âƒ£ Ø£ÙÙƒØ±... Ù‡Ù„ Ø£Ø±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ"]}
]

COLOR_QUESTIONS = [
    {"question": "ğŸ¨ Ø§Ø®ØªØ± Ù„ÙˆÙ†Ø§Ù‹ ÙŠÙ…Ø«Ù„ Ø·ÙÙˆÙ„ØªÙƒ:", "options": ["1ï¸âƒ£ Ø£Ø²Ø±Ù‚ (Ø§Ù„Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø­Ø±ÙŠØ©)", "2ï¸âƒ£ Ø£ØµÙØ± (Ø§Ù„Ø´Ù…Ø³ ÙˆØ§Ù„ÙØ±Ø­)", "3ï¸âƒ£ Ø£Ø®Ø¶Ø± (Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ÙˆØ§Ù„Ù†Ù…Ùˆ)", "4ï¸âƒ£ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ (Ø§Ù„Ø¯ÙØ¡ ÙˆØ§Ù„Ø­ÙŠÙˆÙŠØ©)"]},
    {"question": "ğŸ¨ Ù„ÙˆÙ† ÙŠÙ…Ø«Ù„ Ø­ÙŠØ§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:", "options": ["1ï¸âƒ£ Ø£Ø­Ù…Ø± (Ø§Ù„Ø´ØºÙ ÙˆØ§Ù„Ø·Ø§Ù‚Ø©)", "2ï¸âƒ£ Ø±Ù…Ø§Ø¯ÙŠ (Ø§Ù„Ù‡Ø¯ÙˆØ¡ ÙˆØ§Ù„ØªÙˆØ§Ø²Ù†)", "3ï¸âƒ£ Ø¨Ù†ÙØ³Ø¬ÙŠ (Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØ§Ù„ØºÙ…ÙˆØ¶)", "4ï¸âƒ£ ÙˆØ±Ø¯ÙŠ (Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„Ø­Ù†Ø§Ù†)"]},
    {"question": "ğŸ¨ Ù„ÙˆÙ† ØªØªØ¬Ù†Ø¨Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹:", "options": ["1ï¸âƒ£ Ø£Ø³ÙˆØ¯ (Ø§Ù„Ø¸Ù„Ø§Ù…)", "2ï¸âƒ£ Ø¨Ù†ÙŠ (Ø§Ù„Ù…Ù…Ù„)", "3ï¸âƒ£ Ø±Ù…Ø§Ø¯ÙŠ (Ø§Ù„Ø­Ø²Ù†)", "4ï¸âƒ£ Ù„Ø§ Ø£ØªØ¬Ù†Ø¨ Ø£ÙŠ Ù„ÙˆÙ†"]},
    {"question": "ğŸ¨ Ù„ÙˆÙ† ØªØ±ÙŠØ¯ Ø£Ù† ØªØµØ¨Øº Ø¨Ù‡ ØºØ±ÙØªÙƒ:", "options": ["1ï¸âƒ£ Ø£Ø¨ÙŠØ¶ (Ø§Ù„Ù†Ù‚Ø§Ø¡)", "2ï¸âƒ£ Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ (Ø§Ù„Ù‡Ø¯ÙˆØ¡)", "3ï¸âƒ£ Ø¨ÙŠØ¬ (Ø§Ù„Ø¯ÙØ¡)", "4ï¸âƒ£ Ø£Ù„ÙˆØ§Ù† Ù…ØªØ¹Ø¯Ø¯Ø©"]},
    {"question": "ğŸ¨ Ù„ÙˆÙ† ÙŠÙ…Ø«Ù„ Ø£Ø­Ù„Ø§Ù…Ùƒ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©:", "options": ["1ï¸âƒ£ Ø°Ù‡Ø¨ÙŠ (Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„Ø«Ø±ÙˆØ©)", "2ï¸âƒ£ ÙØ¶ÙŠ (Ø§Ù„Ø£Ù†Ø§Ù‚Ø© ÙˆØ§Ù„Ø±Ù‚ÙŠ)", "3ï¸âƒ£ Ø£Ø®Ø¶Ø± Ø²Ù…Ø±Ø¯ÙŠ (Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ø³ØªÙ…Ø±)", "4ï¸âƒ£ Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ (Ø§Ù„Ø³Ù„Ø§Ù…)"]}
]

DOORS_QUESTIONS = [
    {"question": "ğŸšª Ø£Ù…Ø§Ù…Ùƒ Ø£Ø±Ø¨Ø¹Ø© Ø£Ø¨ÙˆØ§Ø¨... Ø£ÙŠÙ‡Ø§ ØªØ®ØªØ§Ø±ØŸ", "options": ["1ï¸âƒ£ Ø¨Ø§Ø¨ Ø°Ù‡Ø¨ÙŠ Ù„Ø§Ù…Ø¹", "2ï¸âƒ£ Ø¨Ø§Ø¨ Ø®Ø´Ø¨ÙŠ Ù‚Ø¯ÙŠÙ…", "3ï¸âƒ£ Ø¨Ø§Ø¨ Ø²Ø¬Ø§Ø¬ÙŠ Ø´ÙØ§Ù", "4ï¸âƒ£ Ø¨Ø§Ø¨ Ø­Ø¯ÙŠØ¯ÙŠ Ù‚ÙˆÙŠ"]},
    {"question": "ğŸ”‘ ØªØ­ØªØ§Ø¬ Ù…ÙØªØ§Ø­Ø§Ù‹... Ø£ÙŠÙ† ØªØ¨Ø­Ø«ØŸ", "options": ["1ï¸âƒ£ ØªØ­Øª Ø§Ù„Ø³Ø¬Ø§Ø¯Ø©", "2ï¸âƒ£ ÙÙˆÙ‚ Ø§Ù„Ø¨Ø§Ø¨", "3ï¸âƒ£ ÙÙŠ Ø¬ÙŠØ¨ÙŠ", "4ï¸âƒ£ Ø£ÙƒØ³Ø± Ø§Ù„Ø¨Ø§Ø¨"]},
    {"question": "ğŸšª Ø®Ù„Ù Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„: ØºØ±ÙØ© Ù…Ø¸Ù„Ù…Ø©...", "options": ["1ï¸âƒ£ Ø£Ø¯Ø®Ù„ Ø¨Ø´Ø¬Ø§Ø¹Ø©", "2ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ØµØ¨Ø§Ø­ Ø£ÙˆÙ„Ø§Ù‹", "3ï¸âƒ£ Ø£Ù†Ø§Ø¯ÙŠ ÙˆØ£Ø³Ø£Ù„ Ø¥Ù† ÙƒØ§Ù† Ø£Ø­Ø¯ Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„", "4ï¸âƒ£ Ø£ØºÙ„Ù‚ Ø§Ù„Ø¨Ø§Ø¨ ÙˆØ£Ø®ØªØ§Ø± Ø¨Ø§Ø¨Ø§Ù‹ Ø¢Ø®Ø±"]},
    {"question": "ğŸšª Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: ÙŠÙ‚ÙˆØ¯Ùƒ Ù„Ø­Ø¯ÙŠÙ‚Ø© Ø¬Ù…ÙŠÙ„Ø©...", "options": ["1ï¸âƒ£ Ø£Ø³ØªÙƒØ´Ù Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©", "2ï¸âƒ£ Ø£Ù‚Ø·Ù Ø§Ù„Ø²Ù‡ÙˆØ±", "3ï¸âƒ£ Ø£Ø¬Ù„Ø³ ÙˆØ£Ø³ØªØ±ÙŠØ­", "4ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø§Ø¨ Ø¢Ø®Ø±"]},
    {"question": "ğŸšª Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø«Ø§Ù„Ø«: ØºØ±ÙØ© Ù…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„Ù…Ø±Ø§ÙŠØ§...", "options": ["1ï¸âƒ£ Ø£Ù†Ø¸Ø± Ø¥Ù„Ù‰ Ù†ÙØ³ÙŠ", "2ï¸âƒ£ Ø£Ø´Ø¹Ø± Ø¨Ø§Ù„Ø­ÙŠØ±Ø©", "3ï¸âƒ£ Ø£Ø­Ø·Ù… Ø§Ù„Ù…Ø±Ø§ÙŠØ§", "4ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø®Ø±Ø¬"]},
    {"question": "ğŸšª Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø¯Ø±Ø¬ ÙŠØµØ¹Ø¯ Ù„Ù„Ø£Ø¹Ù„Ù‰...", "options": ["1ï¸âƒ£ Ø£ØµØ¹Ø¯ Ø¨Ø³Ø±Ø¹Ø©", "2ï¸âƒ£ Ø£ØµØ¹Ø¯ Ø¨Ø­Ø°Ø±", "3ï¸âƒ£ Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ØµØ¹Ø¯", "4ï¸âƒ£ Ø£ÙØ¶Ù„ Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„"]},
    {"question": "ğŸšª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰: ØºØ±ÙØ© Ø¨Ù‡Ø§ ØµÙ†Ø¯ÙˆÙ‚...", "options": ["1ï¸âƒ£ Ø£ÙØªØ­Ù‡ ÙÙˆØ±Ø§Ù‹", "2ï¸âƒ£ Ø£ÙØ­ØµÙ‡ Ø£ÙˆÙ„Ø§Ù‹", "3ï¸âƒ£ Ø£ØªØ¬Ø§Ù‡Ù„Ù‡", "4ï¸âƒ£ Ø£Ø®Ø§Ù Ø£Ù† Ø£ÙØªØ­Ù‡"]},
    {"question": "ğŸšª Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: Ø±Ø³Ø§Ù„Ø© Ù…ÙƒØªÙˆØ¨Ø©...", "options": ["1ï¸âƒ£ Ø£Ù‚Ø±Ø£Ù‡Ø§ Ø¨ÙØ¶ÙˆÙ„", "2ï¸âƒ£ Ø£ØªØ±Ø¯Ø¯ ÙÙŠ Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§", "3ï¸âƒ£ Ø£Ù…Ø²Ù‚Ù‡Ø§", "4ï¸âƒ£ Ø£Ø­ØªÙØ¸ Ø¨Ù‡Ø§ Ø¯ÙˆÙ† Ù‚Ø±Ø§Ø¡Ø©"]},
    {"question": "ğŸšª ØªÙ‚ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§...", "options": ["1ï¸âƒ£ Ø§Ù„Ø­ÙƒÙ…Ø©", "2ï¸âƒ£ Ø§Ù„Ø«Ø±ÙˆØ©", "3ï¸âƒ£ Ø§Ù„Ø­Ø¨", "4ï¸âƒ£ Ø§Ù„Ù‚ÙˆØ©"]},
    {"question": "ğŸšª Ø¢Ø®Ø± Ø¨Ø§Ø¨... ÙŠÙ‚ÙˆØ¯Ùƒ Ø¥Ù„Ù‰:", "options": ["1ï¸âƒ£ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø¬Ø¯ÙŠØ¯", "2ï¸âƒ£ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ", "3ï¸âƒ£ Ù…ÙƒØ§Ù† ØºØ§Ù…Ø¶ Ø¬Ø¯ÙŠØ¯", "4ï¸âƒ£ Ø¯Ø§Ø®Ù„ Ù†ÙØ³Ùƒ"]}
]

ALL_TESTS = {
    "1": {"name": "Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ù…Ù‡Ø¬ÙˆØ±Ø©", "questions": ISLAND_QUESTIONS},
    "2": {"name": "Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ù…Ø³Ø©", "questions": COLOR_QUESTIONS},
    "3": {"name": "Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©", "questions": DOORS_QUESTIONS},
    "4": {"name": "Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ø¹Ù…ÙŠÙ‚", "questions": ISLAND_QUESTIONS},
    "5": {"name": "Ø§Ù„Ù…Ø±Ø¢Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©", "questions": COLOR_QUESTIONS},
    "6": {"name": "Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„ØºØ§Ù…Ø¶Ø©", "questions": DOORS_QUESTIONS},
    "7": {"name": "Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ø³Ø¨Ø¹Ø©", "questions": ISLAND_QUESTIONS}
}

def get_user_data(user_id):
    if user_id not in user_data:
        user_data[user_id] = {'links_count': 0, 'conversation_history': [], 'test_mode': None, 'test_data': {}, 'current_question': 0, 'answers': []}
    return user_data[user_id]

def analyze_test_results(test_name, answers):
    answers_text = ", ".join(answers)
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ù†ÙØ³ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©.

Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: {test_name}
Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: {answers_text}

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ù†ÙØ³ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙˆÙ…ÙØµÙ„Ø§Ù‹ ÙŠØªØ¶Ù…Ù†:

ğŸ§  **Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø®ØµÙŠØ©**
ØªØ­Ù„ÙŠÙ„ Ø¹Ø§Ù… Ù„Ù„Ø´Ø®ØµÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª

ğŸ’­ **Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªÙÙƒÙŠØ±**
ÙƒÙŠÙ ÙŠÙÙƒØ± Ø§Ù„Ø´Ø®Øµ ÙˆÙŠØªØ®Ø° Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª

â¤ï¸ **Ø§Ù„Ø¹ÙˆØ§Ø·Ù ÙˆØ§Ù„Ù…Ø´Ø§Ø¹Ø±**
ÙƒÙŠÙ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹ÙˆØ§Ø·ÙÙ‡ ÙˆÙ…Ø´Ø§Ø¹Ø±Ù‡

ğŸ¤ **Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©**
ÙƒÙŠÙ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª

ğŸ’ª **Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©**
Ø£Ø¨Ø±Ø² Ø§Ù„ØµÙØ§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©

âš ï¸ **Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ·ÙˆÙŠØ±**
Ù…Ø¬Ø§Ù„Ø§Øª ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§

ğŸ¯ **Ø§Ù„Ù†ØµÙŠØ­Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©**
Ù†ØµÙŠØ­Ø© Ø¹Ù…Ù„ÙŠØ© ÙˆÙ…Ù„Ù‡Ù…Ø©

Ø´Ø±ÙˆØ· Ø§Ù„ØªØ­Ù„ÙŠÙ„:
- Ø¹Ù…ÙŠÙ‚ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ
- Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ÙˆÙ…Ø­ÙØ²
- Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ø¶Ø­
- Ù…ÙØµÙ„ (800-1200 ÙƒÙ„Ù…Ø©)
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„"""
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."

def calculate_name_compatibility(name1, name2):
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.

Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„: {name1}
Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: {name2}

Ø§Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚ (Ù…Ù† 1 Ø¥Ù„Ù‰ 100%) ÙˆØ§Ø´Ø±Ø­:

ğŸ’• **Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚**: X%

ğŸ“Š **ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø­Ø±Ù**
- Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
- Ø·Ø§Ù‚Ø© ÙƒÙ„ Ø§Ø³Ù…
- Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ØµÙˆØªÙŠ

â¤ï¸ **Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¹Ø§Ø·ÙÙŠ**
ÙƒÙŠÙ Ø³ØªÙƒÙˆÙ† Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ†Ù‡Ù…Ø§

ğŸ¤ **Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ**
Ù‡Ù„ ÙŠÙ†Ø³Ø¬Ù…Ø§Ù† ÙÙŠ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„Ø¹Ø§Ù…Ø©

â­ **Ø§Ù„Ù†ØµÙŠØ­Ø©**
Ù†ØµØ§Ø¦Ø­ Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©

Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ù„Ù„ØªØ±ÙÙŠÙ‡ ÙˆØ§Ù„ØªØ³Ù„ÙŠØ© ÙÙ‚Ø·"""
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ÙÙ‚."

def calculate_zodiac_compatibility(sign1, sign2):
    prompt = f"""Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ÙÙ„ÙƒÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬.

Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„Ø£ÙˆÙ„: {sign1}
Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„Ø«Ø§Ù†ÙŠ: {sign2}

Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ Ù„Ù„ØªÙˆØ§ÙÙ‚:

â™ˆ **Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ÙƒÙ„ÙŠØ©**: X%

â¤ï¸ **Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¹Ø§Ø·ÙÙŠ**: X%
ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ø·ÙÙŠØ© ÙˆØ§Ù„Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©

ğŸ¤ **Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ**: X%
Ø§Ù„ØµØ¯Ø§Ù‚Ø© ÙˆØ§Ù„ØªÙØ§Ù‡Ù… Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ

ğŸ’¼ **Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ù‡Ù†ÙŠ**: X%
Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©

ğŸ”¥ **Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©**
Ù…Ø§ ÙŠØ¬Ù…Ø¹Ù‡Ù…Ø§ ÙˆÙŠÙ‚ÙˆÙŠÙ‡Ù…Ø§

âš ï¸ **Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©**
Ù…Ø§ Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ø®Ù„Ø§ÙØ§Øª

ğŸ¯ **Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªÙˆØ§ÙÙ‚**
ÙƒÙŠÙ ÙŠØ­Ø§ÙØ¸Ø§Ù† Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©

Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ„ÙƒÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙØµÙ„Ø©"""
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ÙÙ‚."

def chat_with_ai(user_message, history):
    context = "\n".join([f"Ù…Ø³ØªØ®Ø¯Ù…: {h['user']}\nAI: {h['ai']}" for h in history[-3:]])
    prompt = f"""Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙˆØ¯ÙˆØ¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.

Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:
{context}

Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_message}

Ø±Ø¯ Ø¨Ø£Ø³Ù„ÙˆØ¨:
âœ“ ÙˆØ¯ÙˆØ¯ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ
âœ“ Ø¹Ø±Ø¨ÙŠ ÙØµÙŠØ­ ÙˆØ¨Ø³ÙŠØ·
âœ“ Ù…Ø®ØªØµØ± (3-5 Ø£Ø³Ø·Ø± ÙÙ‚Ø·)
âœ“ Ù…ÙÙŠØ¯ ÙˆÙ…Ø¨Ø§Ø´Ø±"""
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except:
        return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."

@app.route("/", methods=["GET"])
def home():
    return "âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!"

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature')
    if not signature:
        abort(400)
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    except Exception as e:
        print(f"Ø®Ø·Ø£: {e}")
        abort(500)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip()
    data = get_user_data(user_id)
    
    if re.search(r'http[s]?://', text):
        data['links_count'] += 1
        if data['links_count'] >= 2:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·"))
        return
    
    reply_text = ""
    
    if text in ["Ø¥ÙŠÙ‚Ø§Ù", "Ø§ÙŠÙ‚Ø§Ù", "stop", "Ø§Ù„ØºØ§Ø¡", "Ø¥Ù„ØºØ§Ø¡", "cancel"]:
        data['test_mode'] = None
        data['current_question'] = 0
        data['answers'] = []
        reply_text = "âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§ÙƒØªØ¨: Ù…Ø³Ø§Ø¹Ø¯Ø©"
    
    elif text in ["Ù…Ø³Ø§Ø¹Ø¯Ø©", "Ù…Ø³Ø§Ø¹Ø¯Ù‡", "help", "Ø§Ù„Ø§ÙˆØ§Ù…Ø±", "Ø§Ù„Ø£ÙˆØ§Ù…Ø±", "Ù‚Ø§Ø¦Ù…Ø©", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"]:
        reply_text = """ğŸ¤– Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©
â€¢ Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©

ğŸ’• Ø§Ù„ØªÙˆØ§ÙÙ‚:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
â€¢ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬

âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø£Ø®Ø±Ù‰:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Ø¥ÙŠÙ‚Ø§Ù (Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
â€¢ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø§Ù…Ø© (Ø§ÙƒØªØ¨ Ø£ÙŠ Ø´ÙŠØ¡)

âœ¨ Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©"""
    
    elif text in ["Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©", "Ø§Ù„ØºØ§Ø¨Ø©", "ØºØ§Ø¨Ø©", "ØºØ§Ø¨Ù‡"]:
        data['test_mode'] = 'forest'
        data['current_question'] = 0
        data['answers'] = []
        q = FOREST_QUESTIONS[0]
        reply_text = f"{q['question']}\n\n" + "\n".join(q['options']) + f"\n\nğŸ“ Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† {len(FOREST_QUESTIONS)}\n\nâš ï¸ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§ÙƒØªØ¨: Ø¥ÙŠÙ‚Ø§Ù"
    
    elif text in ["Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ø¹Ø§Ø¨ Ø´Ø®ØµÙŠØ©", "Ø§Ù„Ø´Ø®ØµÙŠØ©", "Ø£Ù„Ø¹Ø§Ø¨", "Ø§Ù„Ø¹Ø§Ø¨"]:
        reply_text = PERSONALITY_GAMES + "\n\nâš ï¸ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§ÙƒØªØ¨: Ø¥ÙŠÙ‚Ø§Ù"
        data['test_mode'] = 'select_game'
    
    elif text in ["ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡", "ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§Ø³Ù…Ø§Ø¡", "ØªÙˆØ§ÙÙ‚ Ø§Ø³Ù…Ø§Ø¡", "Ø§Ù„Ø£Ø³Ù…Ø§Ø¡", "Ø§Ù„Ø§Ø³Ù…Ø§Ø¡"]:
        reply_text = """ğŸ’• Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡

Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…ÙŠÙ† Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø©:

Ù…Ø«Ø§Ù„:
Ù…Ø­Ù…Ø¯, ÙØ§Ø·Ù…Ø©

Ø£Ùˆ:
Ø£Ø­Ù…Ø¯, Ø³Ø§Ø±Ø©

âš ï¸ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§ÙƒØªØ¨: Ø¥ÙŠÙ‚Ø§Ù"""
        data['test_mode'] = 'name_compatibility'
    
    elif text in ["ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬", "ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø§Ø¨Ø±Ø§Ø¬", "ØªÙˆØ§ÙÙ‚ Ø§Ø¨Ø±Ø§Ø¬", "Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬"]:
        reply_text = """â™ˆ Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬

Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±Ø¬ÙŠÙ† Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø©:

Ø§Ù„Ø£Ø¨Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©:
Ø§Ù„Ø­Ù…Ù„ØŒ Ø§Ù„Ø«ÙˆØ±ØŒ Ø§Ù„Ø¬ÙˆØ²Ø§Ø¡ØŒ Ø§Ù„Ø³Ø±Ø·Ø§Ù†
Ø§Ù„Ø£Ø³Ø¯ØŒ Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ØŒ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ØŒ Ø§Ù„Ø¹Ù‚Ø±Ø¨
Ø§Ù„Ù‚ÙˆØ³ØŒ Ø§Ù„Ø¬Ø¯ÙŠØŒ Ø§Ù„Ø¯Ù„ÙˆØŒ Ø§Ù„Ø­ÙˆØª

Ù…Ø«Ø§Ù„:
Ø§Ù„Ø£Ø³Ø¯, Ø§Ù„Ø­Ù…Ù„

âš ï¸ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§ÙƒØªØ¨: Ø¥ÙŠÙ‚Ø§Ù"""
        data['test_mode'] = 'zodiac_compatibility'
    
    elif data['test_mode'] == 'forest':
        if text in ['1', '2', '3', '4']:
            data['answers'].append(text)
            data['current_question'] += 1
            if data['current_question'] >= len(FOREST_QUESTIONS):
                reply_text = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ...\n\nØ§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øª..."
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
                analysis = analyze_test_results("Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„Ù†ÙØ³ÙŠ", data['answers'])
                line_bot_api.push_message(user_id, TextSendMessage(text=f"ğŸŒ² ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØªÙƒ Ù…Ù† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØºØ§Ø¨Ø©\n\n{analysis}\n\nâœ¨ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ù…ØªØ¹Ø© ÙˆØ§Ù„ØªØ³Ù„ÙŠØ©"))
                data['test_mode'] = None
                data['current_question'] = 0
                data['answers'] = []
                return
            else:
                q = FOREST_QUESTIONS[data['current_question']]
                reply_text = f"{q['question']}\n\n" + "\n".join(q['options']) + f"\n\nğŸ“ Ø§Ù„Ø³Ø¤Ø§Ù„ {data['current_question'] + 1} Ù…Ù† {len(FOREST_QUESTIONS)}"
        else:
reply_text = "âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø±Ù‚Ù…Ø§Ù‹ Ù…Ù† 1 Ø¥Ù„Ù‰ 4 ÙÙ‚Ø·"
    
    elif data['test_mode'] == 'select_game':
        if text in ['1', '2', '3', '4', '5', '6', '7']:
            game = ALL_TESTS.get(text)
            if game:
                data['test_mode'] = f'game_{text}'
                data['current_question'] = 0
                data['answers'] = []
                data['game_name'] = game['name']
                q = game['questions'][0]
                reply_text = f"ğŸ® {game['name']}\n\n{q['question']}\n\n" + "\n".join(q['options']) + f"\n\nğŸ“ Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† {len(game['questions'])}\n\nâš ï¸ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§ÙƒØªØ¨: Ø¥ÙŠÙ‚Ø§Ù"
        else:
            reply_text = "âš ï¸ Ø§Ø®ØªØ± Ø±Ù‚Ù…Ø§Ù‹ Ù…Ù† 1 Ø¥Ù„Ù‰ 7"
    
    elif data['test_mode'] and data['test_mode'].startswith('game_'):
        game_num = data['test_mode'].split('_')[1]
        game = ALL_TESTS.get(game_num)
        if text in ['1', '2', '3', '4']:
            data['answers'].append(text)
            data['current_question'] += 1
            if data['current_question'] >= len(game['questions']):
                reply_text = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ...\n\nØ§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øª..."
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
                analysis = analyze_test_results(data['game_name'], data['answers'])
                line_bot_api.push_message(user_id, TextSendMessage(text=f"ğŸ® ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØªÙƒ Ù…Ù† Ù„Ø¹Ø¨Ø© {data['game_name']}\n\n{analysis}\n\nâœ¨ Ù„Ù„Ù…ØªØ¹Ø© ÙˆØ§Ù„ØªØ³Ù„ÙŠØ©"))
                data['test_mode'] = None
                data['current_question'] = 0
                data['answers'] = []
                return
            else:
                q = game['questions'][data['current_question']]
                reply_text = f"{q['question']}\n\n" + "\n".join(q['options']) + f"\n\nğŸ“ Ø§Ù„Ø³Ø¤Ø§Ù„ {data['current_question'] + 1} Ù…Ù† {len(game['questions'])}"
        else:
            reply_text = "âš ï¸ Ø§Ø®ØªØ± Ø±Ù‚Ù…Ø§Ù‹ Ù…Ù† 1 Ø¥Ù„Ù‰ 4"
    
    elif data['test_mode'] == 'name_compatibility':
        if ',' in text or 'ØŒ' in text:
            names = re.split('[,ØŒ]', text)
            if len(names) == 2:
                name1 = names[0].strip()
                name2 = names[1].strip()
                reply_text = "â³ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ÙÙ‚...\n\nØ§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øª..."
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
                compatibility = calculate_name_compatibility(name1, name2)
                line_bot_api.push_message(user_id, TextSendMessage(text=f"ğŸ’• Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† {name1} Ùˆ {name2}\n\n{compatibility}\n\nâœ¨ Ù„Ù„ØªØ±ÙÙŠÙ‡ ÙˆØ§Ù„ØªØ³Ù„ÙŠØ© ÙÙ‚Ø·"))
                data['test_mode'] = None
                return
            else:
                reply_text = "âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù…ÙŠÙ† ÙÙ‚Ø· Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø©"
        else:
            reply_text = "âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…ÙŠÙ† Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø© (ØŒ)\n\nÙ…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ØŒ ÙØ§Ø·Ù…Ø©"
    
    elif data['test_mode'] == 'zodiac_compatibility':
        if ',' in text or 'ØŒ' in text:
            signs = re.split('[,ØŒ]', text)
            if len(signs) == 2:
                sign1 = signs[0].strip()
                sign2 = signs[1].strip()
                reply_text = "â³ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ÙÙ„ÙƒÙŠ...\n\nØ§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø§Øª..."
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
                compatibility = calculate_zodiac_compatibility(sign1, sign2)
                line_bot_api.push_message(user_id, TextSendMessage(text=f"â™ˆ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨ÙŠÙ† Ø¨Ø±Ø¬ {sign1} Ùˆ Ø¨Ø±Ø¬ {sign2}\n\n{compatibility}\n\nâœ¨ Ù„Ù„Ù…ØªØ¹Ø© ÙˆØ§Ù„ØªØ³Ù„ÙŠØ©"))
                data['test_mode'] = None
                return
            else:
                reply_text = "âš ï¸ Ø§ÙƒØªØ¨ Ø¨Ø±Ø¬ÙŠÙ† ÙÙ‚Ø· Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø©"
        else:
            reply_text = "âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±Ø¬ÙŠÙ† Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø© (ØŒ)\n\nÙ…Ø«Ø§Ù„: Ø§Ù„Ø£Ø³Ø¯ØŒ Ø§Ù„Ø­Ù…Ù„"
    
    else:
        ai_response = chat_with_ai(text, data['conversation_history'])
        reply_text = ai_response
        data['conversation_history'].append({'user': text, 'ai': ai_response})
        if len(data['conversation_history']) > 10:
            data['conversation_history'] = data['conversation_history'][-10:]
    
    if reply_text:
        if len(reply_text) > 4500:
            parts = []
            current = ""
            for line in reply_text.split('\n'):
                if len(current) + len(line) + 1 <= 4500:
                    current += line + '\n'
                else:
                    if current:
                        parts.append(current.strip())
                    current = line + '\n'
            if current:
                parts.append(current.strip())
            messages = [TextSendMessage(text=part) for part in parts[:5]]
            line_bot_api.reply_message(event.reply_token, messages)
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port, debug=False)
