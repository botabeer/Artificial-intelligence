from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os
import google.generativeai as genai

app = Flask(__name__)

# ุฅุนุฏุงุฏ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# ุงูุชุญูู ูู ุงููุชุบูุฑุงุช
if not all([LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET, GEMINI_API_KEY]):
    raise ValueError("ูุฌุจ ุชุนููู ุฌููุน ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ุงููุทููุจุฉ")

# ุฅุนุฏุงุฏ LINE Bot
line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# ุฅุนุฏุงุฏ Gemini AI
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-pro')

# ุชุชุจุน ุงูุจูุงูุงุช ููู ูุณุชุฎุฏู
user_data = {}

def get_user_data(user_id):
    """ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุฃู ุฅูุดุงุก ุจูุงูุงุช ุฌุฏูุฏุฉ"""
    if user_id not in user_data:
        user_data[user_id] = {
            'links_count': 0,
            'conversation_history': []
        }
    return user_data[user_id]

def generate_questions(count=10):
    """ุชูููุฏ ุฃุณุฆูุฉ ุนูููุฉ ุจุงุณุชุฎุฏุงู Gemini"""
    prompt = f"""ุฃูุช ุฎุจูุฑ ูู ุทุฑุญ ุฃุณุฆูุฉ ุนูููุฉ ููุซูุฑุฉ ููุชูููุฑ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.
    
ูู ุจุชูููุฏ {count} ุฃุณุฆูุฉ ูุชููุนุฉ ุชุดูู:
- ุฃุณุฆูุฉ ููุณููุฉ ุนูููุฉ
- ุฃุณุฆูุฉ ุนู ุงูุญูุงุฉ ูุงูุชุฌุงุฑุจ ุงูุดุฎุตูุฉ
- ุฃุณุฆูุฉ ุชุญูุฒ ุงูุชุฃูู ุงูุฐุงุชู
- ุฃุณุฆูุฉ ุนู ุงูุฃุญูุงู ูุงูุทููุญุงุช
- ุฃุณุฆูุฉ ุนู ุงูุนูุงูุงุช ูุงููุดุงุนุฑ

ุดุฑูุท ุงูุฃุณุฆูุฉ:
โ ูุฌุจ ุฃู ุชููู ุงูุฃุณุฆูุฉ ูุฎุชููุฉ ุชูุงูุงู ุนู ุจุนุถูุง
โ ุนูููุฉ ูุชุซูุฑ ุงูุชูููุฑ
โ ููุงุณุจุฉ ูุฌููุน ุงูุฃุนูุงุฑ
โ ุจุฃุณููุจ ุจุณูุท ููุงุถุญ
โ ุชุจุฏุฃ ุจุฃุฏูุงุช ุงุณุชููุงู ูุฎุชููุฉ (ูุงุ ูููุ ููุงุฐุงุ ููุ ูุชู)

ุงูุชุจ ูู ุณุคุงู ูู ุณุทุฑ ูููุตู ุจุฏูู ุชุฑููู ุฃู ุฑููุฒ ุฅุถุงููุฉ."""
    
    try:
        response = model.generate_content(prompt)
        questions = [q.strip() for q in response.text.strip().split('\n') if q.strip()]
        return questions[:count]
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุชูููุฏ ุงูุฃุณุฆูุฉ: {e}")
        return ["ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงูุฃุณุฆูุฉุ ุญุงูู ูุฑุฉ ุฃุฎุฑู"]

def generate_riddles(count=5):
    """ุชูููุฏ ุฃูุบุงุฒ ุจุงุณุชุฎุฏุงู Gemini"""
    prompt = f"""ุฃูุช ุฎุจูุฑ ูู ุตูุงุนุฉ ุงูุฃูุบุงุฒ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.

ูู ุจุชูููุฏ {count} ุฃูุบุงุฒ ููุชุนุฉ ููุชููุนุฉ ูู ุญูุซ ุงูุตุนูุจุฉ.

ููู ูุบุฒ:
โ ุงูุชุจ ุงููุบุฒ ูู ุณุทุฑ
โ ุซู ุงูุชุจ ุงูุญู ูู ุงูุณุทุฑ ุงูุชุงูู ุจุงูุดูู: [ุงูุญู: ...]
โ ุงุฌุนู ุงูุฃูุบุงุฒ ููุงุณุจุฉ ูุฌููุน ุงูุฃุนูุงุฑ
โ ูููุน ุจูู ุงูุฃูุบุงุฒ ุงูุณููุฉ ูุงููุชูุณุทุฉ ูุงูุตุนุจุฉ
โ ุงุณุชุฎุฏู ุฃุณููุจ ุดุงุนุฑู ูููุชุน

ูุซุงู ููุตูุบุฉ:
ุดูุก ูู ุฑุฃุณ ูููุณ ูู ุฌุณุฏุ ูุง ููุ
[ุงูุญู: ุงูุฏุจูุณ]

ูุง ุชุถุน ุฃุฑูุงู ุฃู ุนูุงูููุ ููุท ุงููุบุฒ ูุงูุญู."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุชูููุฏ ุงูุฃูุบุงุฒ: {e}")
        return "ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงูุฃูุบุงุฒุ ุญุงูู ูุฑุฉ ุฃุฎุฑู"

def generate_games():
    """ุชูููุฏ ุฃููุงุฑ ุฃูุนุงุจ ุชูุงุนููุฉ ุจุงุณุชุฎุฏุงู Gemini"""
    prompt = """ุฃูุช ุฎุจูุฑ ูู ุงุจุชูุงุฑ ุฃูุนุงุจ ุชูุงุนููุฉ ููุชุนุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.

ูู ุจุชูููุฏ 5 ุฃููุงุฑ ุฃูุนุงุจ ูููู ูุนุจูุง ุนุจุฑ ุงููุญุงุฏุซุฉ ุงููุตูุฉุ ูุซู:
- ุฃูุนุงุจ ุงูุชุฎููู
- ุฃูุนุงุจ ุงููููุงุช
- ุฃูุนุงุจ ุงูุฐุงูุฑุฉ
- ุชุญุฏูุงุช ุฅุจุฏุงุนูุฉ
- ุฃูุนุงุจ ุงูุฃุณุฆูุฉ ุงูุณุฑูุนุฉ

ููู ูุนุจุฉ:
โ ุงุณู ุงููุนุจุฉ
โ ุดุฑุญ ุจุณูุท ููุทุฑููุฉ
โ ูุซุงู ุณุฑูุน

ุงุฌุนู ุงูุดุฑุญ ูุฎุชุตุฑุงู ููุงุถุญุงู ูููุชุนุงู."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุชูููุฏ ุงูุฃูุนุงุจ: {e}")
        return "ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงูุฃูุนุงุจุ ุญุงูู ูุฑุฉ ุฃุฎุฑู"

def analyze_personality(user_message):
    """ุชุญููู ุงูุดุฎุตูุฉ ุจูุงุกู ุนูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู"""
    prompt = f"""ุฃูุช ุฎุจูุฑ ูู ุชุญููู ุงูุดุฎุตูุฉ ูุนูู ุงูููุณ.

ูุงู ุงููุณุชุฎุฏู ุจูุชุงุจุฉ: "{user_message}"

ูู ุจุนูู ุชุญููู ุดุฎุตูุฉ ุณุฑูุน ูููุชุน ุจูุงุกู ุนูู ุฃุณููุจ ุงููุชุงุจุฉ ูุงููุญุชูู ูุชุถูู:

๐ ููุน ุงูุดุฎุตูุฉ ุงููุชููุน
๐ก ููุงุท ููุฉ ูุญุชููุฉ
๐ ุตูุงุช ูููุฒุฉ
๐ฏ ูุตูุญุฉ ุจุณูุทุฉ

ููุงุญุธุงุช:
โ ุงุณุชุฎุฏู ุฃุณููุจ ุฅูุฌุงุจู ููุดุฌุน
โ ูุง ุชูู ุชูููุฏูุงูุ ูู ูุจุฏุนุงู
โ ุงุฌุนู ุงูุชุญููู ูุตูุฑ (4-6 ุฃุณุทุฑ)
โ ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุดูู ูุทูู
โ ูุง ุชูู ูุงุณูุงู ูู ุงูุญูู

ุชุฐูุฑ ุฃู ูุฐุง ุชุญููู ูููุฑุญ ูุงูุชุณููุฉ ูููุณ ุชุญูููุงู ููุณูุงู ุฏูููุงู."""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุชุญููู ุงูุดุฎุตูุฉ: {e}")
        return "ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญูููุ ุญุงูู ูุฑุฉ ุฃุฎุฑู"

def chat_with_ai(user_message, history):
    """ูุญุงุฏุซุฉ ุนุงูุฉ ูุน AI"""
    # ุจูุงุก ุงูุณูุงู ูู ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ
    context = "\n".join([f"ูุณุชุฎุฏู: {h['user']}\nAI: {h['ai']}" for h in history[-3:]])
    
    prompt = f"""ุฃูุช ูุณุงุนุฏ ุฐูู ููุฏูุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉ. ุชุญุฏุซ ุจุฃุณููุจ ุทุจูุนู ููุฏู.

ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ:
{context}

ุงููุณุชุฎุฏู ุงูุขู ูููู: {user_message}

ููุงุนุฏ ุงูุฑุฏ:
โ ูู ูุฏูุฏุงู ููุญุชุฑูุงู
โ ุงุณุชุฎุฏู ุฃุณููุจ ุนุฑุจู ูุตูุญ ูุจุณูุท
โ ุฃุฌุจ ุจุดูู ูุจุงุดุฑ ููููุฏ
โ ุฅุฐุง ูุงู ุงูุณุคุงู ูุญุชุงุฌ ูุนูููุงุช ูุญุฏุฏุฉุ ูุฏู ูุนูููุงุช ุฏูููุฉ
โ ููููู ุงุณุชุฎุฏุงู ุงูุฅูููุฌู ุจุงุนุชุฏุงู
โ ูุง ุชูุฑุฑ ููุณ ุงูุนุจุงุฑุงุช
โ ุงุฌุนู ุฑุฏู ูุตูุฑุงู ูุณุจูุงู (3-5 ุฃุณุทุฑ ุฅูุง ุฅุฐุง ูุงู ุงูุณุคุงู ูุชุทูุจ ุชูุตูู)"""
    
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"ุฎุทุฃ ูู ุงููุญุงุฏุซุฉ: {e}")
        return "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุงููุญุงุฏุซุฉ"

@app.route("/", methods=["GET"])
def home():
    return "โ ุงูุจูุช ุดุบุงู ููุนูู ุจูุงูู ุทุงูุชู!"

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature')
    if not signature:
        abort(400)
    
    body = request.get_data(as_text=True)
    
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    except Exception as e:
        print(f"ุฎุทุฃ: {e}")
        abort(500)
    
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip()
    data = get_user_data(user_id)
    
    # ูุญุต ุงูุฑูุงุจุท ุฃููุงู
    if "http://" in text.lower() or "https://" in text.lower():
        data['links_count'] += 1
        
        # ุชุฌุงูู ุงูุฑุงุจุท ุงูุฃูู
        if data['links_count'] == 1:
            return
        
        # ุชุญุฐูุฑ ูู ุงูุฑุงุจุท ุงูุซุงูู ููุง ููู
        if data['links_count'] >= 2:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="โ๏ธ ุชุญุฐูุฑ\n\nูุฑุฌู ุนุฏู ุฅุฑุณุงู ุงูุฑูุงุจุท ุจุดูู ูุชูุฑุฑ ููุญูุงุธ ุนูู ุฌูุฏุฉ ุงููุญุงุฏุซุฉ")
            )
        return
    
    # ุงูุฃูุงูุฑ ุงูุฑุฆูุณูุฉ
    commands = {
        "ูุณุงุนุฏุฉ": ["ูุณุงุนุฏุฉ", "ูุณุงุนุฏู", "help", "ุงูุงูุงูุฑ", "ุงูุฃูุงูุฑ"],
        "ุฃุณุฆูุฉ": ["ุณุคุงู", "ุงุณุฆูุฉ", "ุฃุณุฆูุฉ", "ุงุณุงูู", "ุฃุณุงูู"],
        "ุฃูุบุงุฒ": ["ูุบุฒ", "ุงูุบุงุฒ", "ุฃูุบุงุฒ", "ุงูุฃุบุงุฒ"],
        "ุฃูุนุงุจ": ["ูุนุจุฉ", "ุงูุนุงุจ", "ุฃูุนุงุจ", "ูุนุจ"],
        "ุชุญููู": ["ุชุญููู", "ุชุญูููู", "ุญูู", "ุดุฎุตูุชู", "ุชุญููู ุดุฎุตูุฉ"]
    }
    
    reply_text = ""
    
    # ุงููุณุงุนุฏุฉ
    if text.lower() in commands["ูุณุงุนุฏุฉ"]:
        reply_text = """๐ค ูุฑุญุจุงู ุจู ูู ุงูุจูุช ุงูุฐูู

๐ ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:

๐ญ ุณุคุงู - ุงุญุตู ุนูู ุฃุณุฆูุฉ ุนูููุฉ ููุซูุฑุฉ ููุชูููุฑ
๐งฉ ูุบุฒ - ุฃูุบุงุฒ ููุชุนุฉ ูุชุญุฏู ุนููู
๐ฎ ูุนุจุฉ - ุงูุชุดู ุฃูุนุงุจ ุชูุงุนููุฉ ูุณููุฉ
๐ ุชุญููู - ุงูุชุจ ุฃู ูุต ูุณุฃุญูู ุดุฎุตูุชู ููู
๐ฌ ูุญุงุฏุซุฉ ุญุฑุฉ - ุงูุชุจ ุฃู ุดูุก ูุณุฃุฑุฏ ุนููู

ุงุณุชูุชุน ุจุงุณุชุฎุฏุงู ุงูุจูุช! โจ"""
    
    # ุงูุฃุณุฆูุฉ
    elif text.lower() in commands["ุฃุณุฆูุฉ"]:
        questions = generate_questions(10)
        reply_text = "๐ญ ุฃุณุฆูุฉ ุนูููุฉ ููุชูููุฑ\n\n"
        reply_text += "\n\n".join([f"โข {q}" for q in questions])
        reply_text += "\n\nโจ ุฎุฐ ููุชู ูู ุงูุชุฃูู"
    
    # ุงูุฃูุบุงุฒ
    elif text.lower() in commands["ุฃูุบุงุฒ"]:
        riddles = generate_riddles(5)
        reply_text = f"๐งฉ ุฃูุบุงุฒ ูุชุญุฏู ุนููู\n\n{riddles}\n\n๐ค ูู ุงุณุชุทุนุช ุญููุงุ"
    
    # ุงูุฃูุนุงุจ
    elif text.lower() in commands["ุฃูุนุงุจ"]:
        games = generate_games()
        reply_text = f"๐ฎ ุฃูุนุงุจ ุชูุงุนููุฉ ููุชุนุฉ\n\n{games}\n\n๐ฏ ุฌุฑุจ ูุงุณุชูุชุน!"
    
    # ุชุญููู ุงูุดุฎุตูุฉ
    elif text.lower() in commands["ุชุญููู"]:
        reply_text = "๐ ุชุญููู ุงูุดุฎุตูุฉ\n\nุงูุชุจ ุฃู ุฌููุฉ ุฃู ููุฑุฉ ุชุนุจุฑ ุนู ููุณู ูุณุฃุญูู ุดุฎุตูุชู ุจูุงุกู ุนูููุง!\n\nูุซุงู: ุฃูุชุจ ุนู ููููุ ุฃู ุนู ุดูุก ุชุญุจูุ ุฃู ุนู ุญููู"
    
    # ุฅุฐุง ุจุฏุฃ ุจูููุฉ "ุชุญููู:" ุฃู ูุงู ุงูุฑุฏ ุงูุณุงุจู ุนู ุงูุชุญููู
    elif text.lower().startswith("ุชุญููู:") or (data['conversation_history'] and 
          "ุชุญููู ุงูุดุฎุตูุฉ" in data['conversation_history'][-1].get('ai', '')):
        user_input = text.replace("ุชุญููู:", "").strip()
        if len(user_input) < 10:
            reply_text = "๐ ูู ูุถูู ุงูุชุจ ูุต ุฃุทูู ููููุงู (ุนูู ุงูุฃูู ุฌููุฉ ูุงููุฉ) ุญุชู ุฃุณุชุทูุน ุชุญููู ุดุฎุตูุชู ุจุดูู ุฃูุถู"
        else:
            analysis = analyze_personality(user_input)
            reply_text = f"๐ ุชุญููู ุดุฎุตูุชู\n\n{analysis}\n\nโจ ูุฐุง ุชุญููู ูููุฑุญ ูุงูุชุณููุฉ"
    
    # ูุญุงุฏุซุฉ ุนุงูุฉ
    else:
        ai_response = chat_with_ai(text, data['conversation_history'])
        reply_text = ai_response
        
        # ุญูุธ ุงููุญุงุฏุซุฉ ูู ุงูุณุฌู
        data['conversation_history'].append({
            'user': text,
            'ai': ai_response
        })
        
        # ุงูุงุญุชูุงุธ ุจุขุฎุฑ 10 ูุญุงุฏุซุงุช ููุท
        if len(data['conversation_history']) > 10:
            data['conversation_history'] = data['conversation_history'][-10:]
    
    # ุฅุฑุณุงู ุงูุฑุฏ
    if reply_text:
        # ุชูุณูู ุงูุฑุณุงูุฉ ุฅุฐุง ูุงูุช ุทูููุฉ (LINE ูุฏูู ุญุฏ 5000 ุญุฑู)
        if len(reply_text) > 4500:
            messages = [reply_text[i:i+4500] for i in range(0, len(reply_text), 4500)]
            line_bot_api.reply_message(
                event.reply_token,
                [TextSendMessage(text=msg) for msg in messages[:5]]  # ุญุฏ ุฃูุตู 5 ุฑุณุงุฆู
            )
        else:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=reply_text)
            )

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port, debug=False)
